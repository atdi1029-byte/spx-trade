<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#12100e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>SPX Trade Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nosifer&family=Noto+Serif+JP:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-deep: #12100e;
            --bg-dark: #1a1815;
            --bg-card: #221f1a;
            --bg-card-hover: #2a2620;
            --border: #3a3530;
            --border-light: #4a4238;
            --text: #d4c8b0;
            --text-dim: #8a7e6a;
            --text-bright: #f0e6cc;
            --pumpkin: #d4843e;
            --pumpkin-glow: #e8a04c;
            --pumpkin-deep: #b8602a;
            --green-candle: #4a8a4a;
            --green-bright: #6aaa5a;
            --green-dim: #3d5c3d;
            --red-candle: #c44b3f;
            --red-bright: #e05545;
            --cream: #e8d5a8;
            --moon: #f5ecd0;
            --navy: #2d3040;
        }

        body {
            font-family: 'Space Mono', 'Noto Serif JP', monospace;
            background: var(--bg-deep);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Full background image */
        .bg-watermark {
            position: fixed;
            top: -15vh; left: 0;
            width: 100vw;
            height: 115vh;
            object-fit: cover;
            object-position: center top;
            opacity: 0.55;
            pointer-events: none;
            z-index: 0;
        }

        /* ============ SVG BACKGROUND SCENE ============ */
        .scene-bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* ============ FOG ANIMATION ============ */
        @keyframes drift-right {
            0% { transform: translateX(-10%); opacity: 0.3; }
            50% { opacity: 0.5; }
            100% { transform: translateX(10%); opacity: 0.3; }
        }
        @keyframes drift-left {
            0% { transform: translateX(10%); opacity: 0.25; }
            50% { opacity: 0.45; }
            100% { transform: translateX(-10%); opacity: 0.25; }
        }
        @keyframes moon-glow {
            0%, 100% { filter: drop-shadow(0 0 30px #f5ecd044); }
            50% { filter: drop-shadow(0 0 50px #f5ecd066); }
        }
        @keyframes sway {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }
        @keyframes sway-reverse {
            0%, 100% { transform: rotate(2deg); }
            50% { transform: rotate(-2deg); }
        }
        @keyframes float-coin {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.15; }
            50% { transform: translateY(-8px) rotate(10deg); opacity: 0.25; }
        }

        /* ============ MAIN CONTENT ============ */
        .content {
            position: relative;
            z-index: 1;
            padding: 1.5rem 2rem 4rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ============ HEADER ============ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
            border-image: linear-gradient(90deg, transparent, var(--pumpkin-deep), var(--border), transparent) 1;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .header-logo {
            width: 160px;
            height: 160px;
            border-radius: 18px;
            border: 2px solid var(--pumpkin-deep);
            box-shadow: 0 0 25px #d4843e44;
        }
        .header h1 {
            font-family: 'Noto Serif JP', serif;
            font-size: 3.5rem;
            font-weight: 900;
            color: var(--cream);
            letter-spacing: 3px;
            line-height: 1;
        }
        .header h1 span {
            font-family: 'Nosifer', cursive;
            font-size: 3.8rem;
            color: var(--pumpkin);
            text-shadow: 0 0 25px #d4843e44, 0 3px 6px #00000066;
            letter-spacing: 6px;
        }
        .header-sub {
            font-size: 0.85rem;
            color: var(--text-dim);
            letter-spacing: 5px;
            text-transform: uppercase;
            margin-top: 4px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .refresh-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--pumpkin-glow);
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        .refresh-btn:hover {
            background: var(--border);
            border-color: var(--pumpkin-deep);
            box-shadow: 0 0 10px #d4843e22;
        }
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--green-candle);
            display: inline-block;
            margin-right: 4px;
            box-shadow: 0 0 6px #4a8a4a66;
        }
        .status-dot.error { background: var(--red-candle); box-shadow: 0 0 6px #c44b3f66; }
        .status-dot.loading { background: var(--pumpkin); animation: pulse 1s infinite; box-shadow: 0 0 6px #d4843e66; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* ============ SECTION HEADERS ============ */
        .section-header {
            font-family: 'Noto Serif JP', serif;
            font-size: 1rem;
            font-weight: 700;
            color: var(--cream);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-left: 12px;
            border-left: 3px solid var(--pumpkin);
        }
        .section-header .count {
            background: var(--pumpkin-deep);
            color: var(--cream);
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: 700;
        }

        /* ============ QUOTE BANNER ============ */
        .quote-banner {
            text-align: center;
            padding: 0.8rem 2rem;
            margin-bottom: 1.25rem;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            border-image: linear-gradient(90deg, transparent, var(--border-light), transparent) 1;
            animation: fadeIn 1s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .quote-text {
            font-family: 'Noto Serif JP', serif;
            font-size: 0.85rem;
            font-style: italic;
            color: var(--cream);
            opacity: 0.7;
            line-height: 1.5;
        }
        .quote-author {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            color: var(--pumpkin);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-top: 0.3rem;
            opacity: 0.6;
        }

        /* ============ WEEKLY TASKS ============ */
        .weekly-tasks { margin-bottom: 1.25rem; }
        .weekly-tasks-list {
            background: var(--bg-card);
            border: 2px solid var(--pumpkin);
            border-radius: 10px;
            padding: 0.4rem 1rem;
            display: flex; flex-direction: column; gap: 0;
            box-shadow: 0 0 15px rgba(212, 132, 62, 0.15);
        }
        .weekly-task-item {
            display: flex; align-items: center; gap: 0.6rem;
            padding: 0.3rem 0.35rem;
            border-bottom: 1px solid rgba(58, 53, 48, 0.6);
            cursor: pointer; transition: opacity 0.2s, background 0.2s; border-radius: 4px;
        }
        .weekly-task-item:last-child { border-bottom: none; }
        .weekly-task-item:hover { background: rgba(212, 132, 62, 0.08); }
        .weekly-task-item.checked { opacity: 0.35; }
        .weekly-task-item.checked .task-text { text-decoration: line-through; }
        .weekly-task-checkbox {
            width: 20px; height: 20px; border: 2px solid var(--pumpkin);
            border-radius: 4px; flex-shrink: 0; display: flex; align-items: center;
            justify-content: center; background: rgba(212, 132, 62, 0.08);
            transition: all 0.2s; box-shadow: 0 0 6px rgba(212, 132, 62, 0.2);
        }
        .weekly-task-item:hover .weekly-task-checkbox { box-shadow: 0 0 10px rgba(212, 132, 62, 0.35); }
        .weekly-task-item.checked .weekly-task-checkbox { background: var(--green-candle); border-color: var(--green-candle); box-shadow: 0 0 8px rgba(74, 138, 74, 0.4); }
        .weekly-task-item.checked .weekly-task-checkbox::after { content: '\2713'; color: var(--text-bright); font-size: 0.8rem; font-weight: 700; }
        .task-text { font-family: 'Space Mono', monospace; font-size: 0.75rem; color: var(--text-bright); transition: all 0.2s; }

        /* ============ 4-DAY CHECK ============ */
        .action-btn.four-day-btn { background: rgba(58, 53, 48, 0.3); color: var(--text-dim); border-color: rgba(58, 53, 48, 0.5); opacity: 0.5; }
        .action-btn.four-day-btn:hover { background: rgba(58, 53, 48, 0.5); color: var(--text); opacity: 0.8; }
        .action-btn.four-day-btn.checked { background: var(--green-dim); color: var(--green-bright); border-color: var(--green-candle); opacity: 1; }
        .action-btn.four-day-btn.needs-check { background: rgba(196, 75, 63, 0.15); color: var(--red-bright); border-color: var(--red-candle); opacity: 1; animation: flash4day 1.5s ease-in-out infinite alternate; }
        .filter-btn.need-4day-btn.has-alerts { background: rgba(196, 75, 63, 0.15); border-color: var(--red-candle); color: var(--red-bright); animation: flash4day 1s ease-in-out infinite alternate; }
        .filter-btn.need-4day-btn.has-alerts.active { background: rgba(196, 75, 63, 0.3); }
        @keyframes flash4day { from { opacity: 0.6; } to { opacity: 1; box-shadow: 0 0 10px rgba(196, 75, 63, 0.4); } }

        /* ============ QUICK STATS BAR ============ */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--pumpkin-deep), transparent);
        }
        .stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--cream);
            line-height: 1.2;
        }
        .stat-value.green { color: var(--green-bright); text-shadow: 0 0 15px rgba(106,170,90,0.8), 0 0 40px rgba(106,170,90,0.4), 0 0 60px rgba(106,170,90,0.15); }
        .stat-value.red { color: var(--red-bright); text-shadow: 0 0 15px rgba(224,85,69,0.8), 0 0 40px rgba(224,85,69,0.4), 0 0 60px rgba(224,85,69,0.15); }
        .glow-green { color: var(--green-bright); text-shadow: 0 0 15px rgba(106,170,90,0.8), 0 0 40px rgba(106,170,90,0.4), 0 0 60px rgba(106,170,90,0.15); }
        .glow-red { color: var(--red-bright); text-shadow: 0 0 15px rgba(224,85,69,0.8), 0 0 40px rgba(224,85,69,0.4), 0 0 60px rgba(224,85,69,0.15); }
        .stat-label {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 6px;
        }

        /* ============ ACTION NEEDED ============ */
        .action-section { margin-bottom: 1.5rem; }
        .action-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .action-item {
            background: var(--bg-card);
            border: 1px solid var(--pumpkin-deep);
            border-left: 4px solid var(--pumpkin);
            border-radius: 4px;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .action-item .ticker-badge {
            background: var(--pumpkin);
            color: var(--bg-deep);
            font-weight: 700;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 0.75rem;
            letter-spacing: 1px;
        }
        .action-item .message { font-size: 0.8rem; color: var(--cream); }
        .action-item .meta { font-size: 0.7rem; color: var(--text-dim); }
        .action-buttons {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.5rem;
        }
        .action-btn {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 5px 12px;
            border-radius: 3px;
            border: 1px solid var(--border);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        .action-btn:hover { transform: translateY(-1px); }
        .action-btn.entered {
            background: var(--green-dim);
            color: var(--green-bright);
            border-color: var(--green-candle);
        }
        .action-btn.entered:hover { background: var(--green-candle); color: var(--cream); }
        .action-btn.skipped {
            background: var(--bg-dark);
            color: var(--text-dim);
            border-color: var(--border);
        }
        .action-btn.skipped:hover { background: var(--border); color: var(--text); }
        .action-btn.tp-hit {
            background: var(--green-dim);
            color: var(--green-bright);
            border-color: var(--green-candle);
        }
        .action-btn.tp-hit:hover { background: var(--green-candle); color: var(--cream); }
        .action-btn.stopped-out {
            background: #c44b3f22;
            color: var(--red-bright);
            border-color: var(--red-candle);
        }
        .action-btn.stopped-out:hover { background: var(--red-candle); color: var(--cream); }
        .action-btn.open-pos {
            background: #1f6feb22;
            color: #6a9fdb;
            border-color: #1f6feb44;
        }
        .action-btn.open-pos:hover { background: #1f6feb44; color: var(--cream); }
        .action-btn.won { background: var(--green-dim); color: var(--green-bright); border-color: var(--green-candle); }
        .action-btn.won:hover { background: var(--green-candle); color: var(--cream); }
        .action-btn.lost { background: #c44b3f22; color: var(--red-bright); border-color: var(--red-candle); }
        .action-btn.lost:hover { background: var(--red-candle); color: var(--cream); }
        .action-btn.zero { background: #1f6feb22; color: #6a9fdb; border-color: #1f6feb44; }
        .action-btn.zero:hover { background: #1f6feb44; color: var(--cream); }
        .action-btn.close-trade { background: #f5a62322; color: #f5a623; border-color: #f5a62344; display: none; }
        .action-btn.close-trade:hover { background: #f5a62344; color: var(--cream); }
        .pnl-badge { display: inline-block; font-size: 0.5rem; font-weight: 700; padding: 1px 6px; border-radius: 3px; margin-left: 0; vertical-align: middle; }
        .pnl-badge.positive { background: var(--green-dim); color: var(--green-bright); }
        .pnl-badge.negative { background: #c44b3f22; color: var(--red-bright); }
        .pnl-badge.neutral { background: #1f6feb22; color: #6a9fdb; }
        .stock-logo { width: 22px; height: 22px; border-radius: 50%; object-fit: contain; background: var(--bg-dark); border: 1px solid var(--border); vertical-align: middle; margin-right: 6px; }
        .stock-logo-fallback { display: inline-flex; width: 22px; height: 22px; border-radius: 50%; align-items: center; justify-content: center; font-size: 0.45rem; font-weight: 700; color: var(--cream); background: var(--pumpkin-deep); vertical-align: middle; margin-right: 6px; }
        .ticker-card .stock-logo, .ticker-card .stock-logo-fallback { width: 28px; height: 28px; font-size: 0.5rem; margin-right: 0; }
        .open-trades-filters { display: flex; gap: 0.4rem; margin-bottom: 0.5rem; }
        .filter-btn {
            font-family: 'Space Mono', monospace; font-size: 0.55rem; font-weight: 700; padding: 4px 12px;
            border-radius: 3px; border: 1px solid var(--border); background: var(--bg-dark); color: var(--text-dim);
            cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s;
        }
        .filter-btn:hover { border-color: var(--pumpkin); color: var(--text); }
        .filter-btn.active { background: var(--pumpkin-deep); color: var(--cream); border-color: var(--pumpkin); }
        .action-btn:disabled {
            opacity: 0.4;
            cursor: default;
            transform: none;
        }
        /* Entry size input */
        .entry-input {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--cream);
            padding: 4px 8px;
            border-radius: 3px;
            width: 60px;
            text-align: center;
        }
        .entry-input::placeholder { color: var(--text-dim); }
        .entry-input:focus { outline: none; border-color: var(--pumpkin); }
        .no-actions {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1.5rem;
            text-align: center;
            color: var(--green-candle);
            font-size: 0.8rem;
        }

        /* ============ BUY/SELL TOGGLE ============ */
        .side-toggle {
            display: flex;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow: hidden;
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .side-toggle button {
            padding: 4px 10px;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            background: transparent;
            color: var(--text-dim);
            font-family: inherit;
            font-size: inherit;
            font-weight: inherit;
            letter-spacing: inherit;
        }
        .side-toggle button.active-buy {
            background: var(--green-dim);
            color: var(--green-bright);
        }
        .side-toggle button.active-sell {
            background: #c44b3f33;
            color: var(--red-bright);
        }
        .side-toggle button:hover:not(.active-buy):not(.active-sell) {
            background: var(--border);
            color: var(--text);
        }
        .ticker-side-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.5rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 2px;
            margin-left: 0.5rem;
        }
        .ticker-side-label.buy { color: var(--green-bright); }
        .ticker-side-label.sell { color: var(--red-bright); }

        /* ============ TICKER GRID ============ */
        .ticker-search-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }
        .ticker-search-bar input {
            flex: 1;
            max-width: 300px;
            padding: 0.4rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--cream);
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
        }
        .ticker-search-bar input::placeholder { color: var(--text-dim); }
        .ticker-search-bar input:focus {
            outline: none;
            border-color: var(--pumpkin);
        }
        .ticker-search-bar button {
            padding: 0.4rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-dim);
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ticker-search-bar button:hover { border-color: var(--pumpkin); color: var(--cream); }
        .ticker-search-bar button.active {
            background: var(--pumpkin-deep);
            border-color: var(--pumpkin);
            color: var(--cream);
        }
        .ticker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .ticker-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            transition: all 0.25s;
            position: relative;
            overflow: hidden;
        }
        .ticker-card::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 40px;
            background: linear-gradient(transparent, #1a181508);
            pointer-events: none;
        }
        .ticker-card:hover {
            border-color: var(--pumpkin-deep);
            box-shadow: 0 4px 20px #0008, 0 0 15px #d4843e11;
            transform: translateY(-2px);
        }
        .ticker-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .ticker-name {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.2rem;
            font-weight: 900;
            color: var(--cream);
            letter-spacing: 1px;
        }
        .ticker-status {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .ticker-status.OPEN { background: #1f6feb22; color: #6a9fdb; border: 1px solid #1f6feb44; }
        .ticker-status.PROFIT { background: #3d5c3d44; color: var(--green-bright); border: 1px solid var(--green-dim); }
        .ticker-status.STOPPED { background: #c44b3f22; color: var(--red-bright); border: 1px solid #c44b3f44; }
        .ticker-status.IDLE { background: var(--bg-dark); color: var(--text-dim); border: 1px solid var(--border); }
        .ticker-status.NEW_SIGNAL { background: #d4843e22; color: var(--pumpkin-glow); border: 1px solid var(--pumpkin-deep); }

        .ticker-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.35rem 1rem;
            font-size: 0.75rem;
        }
        .ticker-detail dt { color: var(--text-dim); font-size: 0.65rem; letter-spacing: 0.5px; }
        .ticker-detail dd { color: var(--text); font-weight: 700; text-align: right; }
        .ticker-detail dd.green { color: var(--green-bright); }
        .ticker-detail dd.red { color: var(--red-bright); }
        .ticker-phase {
            margin-top: 0.6rem;
            padding-top: 0.6rem;
            border-top: 1px solid var(--border);
            font-size: 0.65rem;
            color: var(--text-dim);
            font-style: italic;
        }
        .ticker-action {
            font-size: 0.7rem;
            color: var(--pumpkin-glow);
            margin-top: 0.3rem;
        }
        .ticker-links {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.6rem;
            padding-top: 0.6rem;
            border-top: 1px solid var(--border);
        }
        .ticker-link {
            font-family: 'Space Mono', monospace;
            font-size: 0.5rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 3px;
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-dim);
        }
        .ticker-link:hover {
            border-color: var(--pumpkin-deep);
            color: var(--cream);
            background: var(--border);
        }
        .ticker-link.tv { color: #2196F3; border-color: #2196F322; }
        .ticker-link.tv:hover { background: #2196F322; border-color: #2196F3; color: #64B5F6; }
        .ticker-link.hl { color: #4ade80; border-color: #4ade8022; }
        .ticker-link.hl:hover { background: #4ade8022; border-color: #4ade80; color: #86efac; }

        /* ============ BADGE DISPLAY ============ */
        .badge-icon { width: 20px; height: 20px; vertical-align: middle; image-rendering: auto; }
        .badge-label { font-family: 'Space Mono', monospace; font-size: 0.5rem; font-weight: 700; color: var(--pumpkin-glow); letter-spacing: 0.5px; vertical-align: middle; }
        .badge-multiplier { font-family: 'Space Mono', monospace; font-size: 0.5rem; font-weight: 700; color: var(--cream); background: var(--pumpkin-deep); padding: 1px 5px; border-radius: 2px; vertical-align: middle; margin-left: 4px; }

        /* ============ ADD TO PORTFOLIO BUTTON ============ */
        .portfolio-btn {
            background: var(--bg-card); border: 1px solid var(--pumpkin-deep); color: var(--pumpkin-glow);
            padding: 6px 16px; border-radius: 4px; cursor: pointer; font-family: 'Space Mono', monospace;
            font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s;
        }
        .portfolio-btn:hover { background: var(--pumpkin-deep); color: var(--cream); box-shadow: 0 0 10px #d4843e33; }

        /* ============ PORTFOLIO MODAL ============ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85); z-index: 9998; display: none;
            align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-box {
            background: var(--bg-card); border: 2px solid var(--pumpkin-deep); border-radius: 10px;
            padding: 1.5rem 2rem; max-width: 550px; width: 90%; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 0 40px rgba(212,132,62,0.3);
        }
        .modal-title {
            font-family: 'Noto Serif JP', serif; font-size: 1.2rem; font-weight: 900;
            color: var(--cream); margin-bottom: 1rem; text-align: center;
        }
        .modal-input {
            width: 100%; padding: 0.6rem 1rem; background: var(--bg-dark); border: 1px solid var(--border);
            border-radius: 4px; color: var(--cream); font-family: 'Space Mono', monospace; font-size: 1rem;
            text-align: center; margin-bottom: 1rem;
        }
        .modal-input:focus { outline: none; border-color: var(--pumpkin); }
        .modal-table {
            width: 100%; border-collapse: collapse; font-size: 0.7rem; margin-bottom: 1rem;
        }
        .modal-table th {
            text-align: left; padding: 6px 8px; border-bottom: 1px solid var(--border);
            color: var(--text-dim); font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px;
        }
        .modal-table td { padding: 6px 8px; border-bottom: 1px solid rgba(58,53,48,0.4); color: var(--text); }
        .modal-table tr.unproven td { opacity: 0.35; }
        .modal-table .alloc-amount { font-weight: 700; color: var(--green-bright); }
        .modal-buttons { display: flex; gap: 0.5rem; justify-content: center; }
        .modal-confirm {
            background: var(--green-dim); color: var(--green-bright); border: 1px solid var(--green-candle);
            padding: 8px 24px; border-radius: 4px; cursor: pointer; font-family: 'Space Mono', monospace;
            font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s;
        }
        .modal-confirm:hover { background: var(--green-candle); color: var(--cream); }
        .modal-confirm:disabled { opacity: 0.4; cursor: default; }
        .modal-cancel {
            background: var(--bg-dark); color: var(--text-dim); border: 1px solid var(--border);
            padding: 8px 24px; border-radius: 4px; cursor: pointer; font-family: 'Space Mono', monospace;
            font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s;
        }
        .modal-cancel:hover { background: var(--border); color: var(--text); }

        /* ============ BOTTOM GRID ============ */
        .bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        /* ============ LEVEL UP OVERLAY ============ */
        .levelup-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            animation: levelupFadeIn 0.5s ease;
        }
        @keyframes levelupFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes levelupPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes levelupGlow {
            0%, 100% { text-shadow: 0 0 20px var(--pumpkin-glow), 0 0 40px rgba(232,160,76,0.5), 0 0 80px rgba(232,160,76,0.2); }
            50% { text-shadow: 0 0 30px var(--pumpkin-glow), 0 0 60px rgba(232,160,76,0.7), 0 0 100px rgba(232,160,76,0.3); }
        }
        @keyframes pokeBounce { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-20px) scale(1.1); } }
        @keyframes pokeEvolve {
            0% { filter: brightness(1) drop-shadow(0 0 10px var(--pumpkin-glow)); transform: scale(1); }
            40% { filter: brightness(3) drop-shadow(0 0 40px white); transform: scale(1.3); }
            60% { filter: brightness(3) drop-shadow(0 0 40px white); transform: scale(1.3); }
            100% { filter: brightness(1) drop-shadow(0 0 20px var(--pumpkin-glow)); transform: scale(1); }
        }
        .levelup-content { text-align: center; animation: levelupPulse 2s ease infinite; }
        .levelup-pokemon {
            width: 160px; height: 160px;
            image-rendering: pixelated;
            animation: pokeBounce 1.5s ease infinite;
            filter: drop-shadow(0 0 20px var(--pumpkin-glow)) drop-shadow(0 0 40px rgba(232,160,76,0.3));
        }
        .levelup-pokemon.evolving { animation: pokeEvolve 1.5s ease forwards; }
        .levelup-title {
            font-size: 2.5rem; font-weight: 900; color: var(--pumpkin-glow);
            letter-spacing: 4px; animation: levelupGlow 2s ease infinite; margin: 0.5rem 0;
        }
        .levelup-detail { font-size: 1rem; color: var(--text-bright); margin-bottom: 0.5rem; line-height: 1.8; }
        .levelup-pokename { font-size: 1.4rem; font-weight: 700; color: var(--cream); letter-spacing: 2px; margin-bottom: 1.5rem; }
        .levelup-tap { font-size: 0.65rem; color: var(--text-dim); letter-spacing: 3px; text-transform: uppercase; }

        /* ============ POKEMON SCALING SECTION ============ */
        .pokemon-section { margin: 1.5rem 0; }
        .pokemon-box {
            background: rgba(18,16,14,0.9);
            border: 2px solid var(--pumpkin-deep);
            border-image: linear-gradient(135deg, var(--pumpkin-deep), var(--border-light), var(--pumpkin-deep)) 1;
            padding: 1.5rem 2rem;
            box-shadow: 0 0 20px rgba(212,132,62,0.15), inset 0 0 30px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .pokemon-box::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: var(--location-bg);
            background-size: cover;
            background-position: center;
            image-rendering: pixelated;
            z-index: -2;
            opacity: 0.8;
        }
        .pokemon-box::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(ellipse at center, rgba(18,16,14,0.5) 0%, rgba(18,16,14,0.8) 100%);
            z-index: -1;
        }
        .pokemon-header { text-align: center; margin-bottom: 1rem; }
        .pokemon-level-name {
            font-size: 1.5rem; font-weight: 900; color: var(--pumpkin-glow);
            text-shadow: 0 0 15px var(--pumpkin-glow), 0 0 30px rgba(232,160,76,0.5);
            letter-spacing: 2px;
        }
        .pokemon-sprite {
            width: 280px; height: 280px; image-rendering: pixelated;
            filter: drop-shadow(0 0 15px var(--pumpkin-glow));
            margin: -2rem 0 -4rem;
        }
        .pokemon-pnl { font-size: 1.1rem; font-weight: 700; margin-top: 0.3rem; }
        .pokemon-pnl.positive { color: var(--green-bright); text-shadow: 0 0 10px var(--green-bright); }
        .pokemon-pnl.negative { color: var(--red-bright); text-shadow: 0 0 10px var(--red-bright); }
        .pokemon-pnl.zero { color: var(--text-dim); }
        .pokemon-range { font-size: 0.6rem; color: var(--text-dim); margin-top: 0.2rem; }
        .pokemon-xp-bar { margin: 0.8rem auto 1rem; max-width: 450px; }
        .pokemon-xp-track {
            height: 14px; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 7px; overflow: hidden;
        }
        .pokemon-xp-fill {
            height: 100%; border-radius: 7px;
            background: linear-gradient(90deg, var(--pumpkin-deep), var(--pumpkin-glow));
            box-shadow: 0 0 10px var(--pumpkin-glow), 0 0 20px rgba(232,160,76,0.3);
            transition: width 0.8s ease;
        }
        .pokemon-xp-labels {
            display: flex; justify-content: space-between;
            margin-top: 0.3rem; font-size: 0.5rem; color: var(--text-dim);
        }
        .pokemon-next-evolve {
            text-align: center; margin-top: 0.8rem; font-size: 0.75rem;
            color: var(--pumpkin-glow); text-shadow: 0 0 8px rgba(232,160,76,0.4);
            font-weight: 700; padding-top: 0.5rem; border-top: 1px solid var(--border);
        }

        @media (max-width: 900px) {
            .bottom-grid { grid-template-columns: 1fr; }
            .ticker-grid {
                grid-template-columns: 1fr;
                max-height: 400px;
                overflow-y: auto;
            }
            .action-item .meta { display: none; }
            .pokemon-section { margin: 1rem 0; }
            .pokemon-box { padding: 1rem 1.2rem; }
            .pokemon-sprite { width: 180px; height: 180px; margin: -1rem 0 -2rem; }
            .pokemon-level-name { font-size: 1.2rem; }
            .pokemon-xp-bar { max-width: 100%; }
            .weekly-tasks { display: none !important; }
            .four-day-btn { display: none !important; }
            .need-4day-btn { display: none !important; }
        }

        /* ============ SIGNALS TABLE ============ */
        .section-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
        }
        .signals-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }
        .signals-table th {
            text-align: left;
            padding: 0.5rem 0.5rem;
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
        }
        .signals-table td {
            padding: 0.45rem 0.5rem;
            border-bottom: 1px solid #221f1a;
        }
        .signals-table tr:hover td { background: #2a262044; }
        .signal-badge {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 2px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .signal-badge.buy { background: var(--green-dim); color: var(--green-bright); }
        .signal-badge.sell { background: #c44b3f33; color: var(--red-bright); }
        .signal-badge.add { background: #1f6feb22; color: #6a9fdb; }
        .signal-badge.reduce { background: #d4843e22; color: var(--pumpkin-glow); }

        /* ============ PERFORMANCE GRID ============ */
        .perf-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.6rem;
        }
        .perf-item {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.75rem;
            text-align: center;
        }
        .perf-item .perf-val {
            font-family: 'Space Mono', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--cream);
        }
        .perf-item .perf-label {
            font-size: 0.55rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 3px;
        }

        /* ============ LOADING / ERROR ============ */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #12100eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .loading-overlay.hidden { display: none; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--pumpkin);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-banner {
            background: #c44b3f18;
            border: 1px solid var(--red-candle);
            border-radius: 4px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            color: var(--red-bright);
            font-size: 0.8rem;
            display: none;
        }
        .error-banner.show { display: block; }

        /* ============ VICTORY GARDEN ============ */
        .graveyard {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding: 3rem 1.5rem 2rem;
            background: url('graveyard-bg.png') center/cover no-repeat;
            border: none;
            border-radius: 0;
            min-height: 200px;
            align-items: flex-end;
            justify-content: center;
            position: relative;
            margin-left: -2rem;
            margin-right: -2rem;
            padding-left: 3rem;
            padding-right: 3rem;
            -webkit-mask-image: radial-gradient(ellipse 60% 55% at center, black 25%, transparent 80%);
            mask-image: radial-gradient(ellipse 60% 55% at center, black 25%, transparent 80%);
        }
        .graveyard::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(ellipse at center, transparent 30%, #12100e66 70%, #12100ecc 100%);
            pointer-events: none;
        }
        .victory-stone {
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: stoneRise 0.5s ease-out;
            position: relative;
            z-index: 1;
        }
        @keyframes stoneRise {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .stone-marker {
            width: 140px;
            position: relative;
        }
        .stone-marker svg {
            width: 100%;
            height: auto;
            filter: drop-shadow(0 4px 8px #0008);
        }
        .stone-date {
            font-family: 'Space Mono', monospace;
            font-size: 0.4rem;
            color: var(--text-dim);
            margin-top: 4px;
        }
        .victory-empty {
            color: var(--text-dim);
            font-size: 0.75rem;
            font-style: italic;
            padding: 1rem;
            text-align: center;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        /* ============ OMIKUJI ============ */
        .omikuji-section {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem 0;
            margin-bottom: 1rem;
        }
        .omikuji-slip {
            width: 120px;
            height: 180px;
            background: linear-gradient(180deg, #e8d5a8, #d4c8a0, #c4b890);
            border-radius: 4px 4px 2px 2px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px #0006, 0 0 20px #d4843e11;
            border: 1px solid #b8a878;
            position: relative;
        }
        .omikuji-slip:hover {
            transform: translateY(-5px) rotate(-2deg);
            box-shadow: 0 8px 25px #0008, 0 0 30px #d4843e22;
        }
        .omikuji-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.5rem;
            font-weight: 700;
            color: #8a7050;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        .omikuji-icon {
            font-size: 1.8rem;
            color: #6a5030;
            writing-mode: vertical-rl;
            font-family: 'Noto Serif JP', serif;
            font-weight: 900;
        }
        .omikuji-hint {
            font-family: 'Space Mono', monospace;
            font-size: 0.4rem;
            color: #8a7050;
            letter-spacing: 1px;
            margin-top: 0.75rem;
            text-transform: uppercase;
            text-align: center;
        }
        .omikuji-result {
            text-align: center;
            max-width: 400px;
            padding: 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            animation: fadeIn 0.5s ease;
        }
        .omikuji-result.hidden { display: none; }
        .omikuji-fortune {
            font-family: 'Noto Serif JP', serif;
            font-size: 1.4rem;
            font-weight: 900;
            margin-bottom: 0.75rem;
        }
        .omikuji-fortune.great { color: var(--green-bright); }
        .omikuji-fortune.good { color: var(--pumpkin-glow); }
        .omikuji-fortune.small { color: var(--cream); }
        .omikuji-fortune.uncertain { color: var(--text-dim); }
        .omikuji-tip {
            font-size: 0.8rem;
            color: var(--text);
            line-height: 1.5;
            font-style: italic;
        }

        /* ============ FOOTER ============ */
        .footer {
            text-align: center;
            padding: 2rem 0 1rem;
            font-size: 0.6rem;
            color: var(--text-dim);
            letter-spacing: 2px;
            text-transform: uppercase;
        }
    </style>
</head>
<body>

<!-- ============ BACKGROUND SCENE (ukiyo-e night) ============ -->
<svg class="scene-bg" viewBox="0 0 1920 1080" preserveAspectRatio="xMidYMid slice" xmlns="http://www.w3.org/2000/svg">
    <defs>
        <!-- Noise texture for washi paper feel -->
        <filter id="grain">
            <feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch"/>
            <feColorMatrix type="saturate" values="0"/>
            <feBlend in="SourceGraphic" mode="multiply" result="noisy"/>
            <feComponentTransfer>
                <feFuncA type="linear" slope="0.08"/>
            </feComponentTransfer>
            <feBlend in="SourceGraphic" mode="normal"/>
        </filter>
        <!-- Moon glow -->
        <radialGradient id="moonGlow" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#f5ecd0" stop-opacity="0.15"/>
            <stop offset="60%" stop-color="#f5ecd0" stop-opacity="0.05"/>
            <stop offset="100%" stop-color="#f5ecd0" stop-opacity="0"/>
        </radialGradient>
        <!-- Fog gradient -->
        <linearGradient id="fog1" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#1a1815" stop-opacity="0"/>
            <stop offset="20%" stop-color="#2a2520" stop-opacity="0.3"/>
            <stop offset="50%" stop-color="#2a2520" stop-opacity="0.5"/>
            <stop offset="80%" stop-color="#2a2520" stop-opacity="0.3"/>
            <stop offset="100%" stop-color="#1a1815" stop-opacity="0"/>
        </linearGradient>
        <linearGradient id="fog2" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#1a1815" stop-opacity="0"/>
            <stop offset="30%" stop-color="#221f1a" stop-opacity="0.25"/>
            <stop offset="60%" stop-color="#221f1a" stop-opacity="0.4"/>
            <stop offset="100%" stop-color="#1a1815" stop-opacity="0"/>
        </linearGradient>
        <!-- Treeline gradient -->
        <linearGradient id="treeGrad" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#1a2018"/>
            <stop offset="100%" stop-color="#12100e"/>
        </linearGradient>
    </defs>

    <!-- Sky gradient -->
    <rect width="1920" height="1080" fill="#12100e"/>
    <rect width="1920" height="600" fill="#161412" opacity="0.5"/>

    <!-- Moon -->
    <g style="animation: moon-glow 6s ease-in-out infinite;">
        <circle cx="1620" cy="140" r="200" fill="url(#moonGlow)"/>
        <circle cx="1620" cy="140" r="65" fill="#f5ecd0" opacity="0.12"/>
        <circle cx="1620" cy="140" r="50" fill="#f5ecd0" opacity="0.08"/>
    </g>

    <!-- Distant tree silhouettes -->
    <path d="M0,380 Q100,340 200,360 Q300,330 400,355 Q500,320 600,350 Q700,310 800,340 Q900,300 1000,330 Q1100,310 1200,335 Q1300,300 1400,325 Q1500,310 1600,330 Q1700,300 1800,320 Q1920,310 1920,340 L1920,450 L0,450Z" fill="url(#treeGrad)" opacity="0.6"/>
    <path d="M0,400 Q150,370 300,390 Q450,360 600,380 Q750,350 900,375 Q1050,345 1200,370 Q1350,355 1500,372 Q1650,350 1800,368 Q1920,358 1920,380 L1920,480 L0,480Z" fill="#12100e" opacity="0.8"/>

    <!-- Susuki grass (pampas grass) - left cluster -->
    <g transform="translate(80, 700)" style="animation: sway 5s ease-in-out infinite; transform-origin: 80px 700px;">
        <line x1="0" y1="380" x2="-20" y2="100" stroke="#4a4030" stroke-width="1.5" opacity="0.4"/>
        <line x1="10" y1="380" x2="5" y2="80" stroke="#4a4030" stroke-width="1.5" opacity="0.35"/>
        <line x1="20" y1="380" x2="35" y2="90" stroke="#4a4030" stroke-width="1.5" opacity="0.3"/>
        <!-- Plumes -->
        <ellipse cx="-20" cy="85" rx="4" ry="20" fill="#6a5a40" opacity="0.3" transform="rotate(-8,-20,85)"/>
        <ellipse cx="5" cy="65" rx="4" ry="22" fill="#6a5a40" opacity="0.25" transform="rotate(3,5,65)"/>
        <ellipse cx="35" cy="75" rx="4" ry="18" fill="#6a5a40" opacity="0.2" transform="rotate(10,35,75)"/>
    </g>

    <!-- Susuki grass - right cluster -->
    <g transform="translate(1780, 720)" style="animation: sway-reverse 6s ease-in-out infinite; transform-origin: 1780px 720px;">
        <line x1="0" y1="360" x2="15" y2="90" stroke="#4a4030" stroke-width="1.5" opacity="0.35"/>
        <line x1="15" y1="360" x2="30" y2="70" stroke="#4a4030" stroke-width="1.5" opacity="0.3"/>
        <line x1="-10" y1="360" x2="-25" y2="100" stroke="#4a4030" stroke-width="1.5" opacity="0.25"/>
        <ellipse cx="15" cy="75" rx="4" ry="20" fill="#6a5a40" opacity="0.25" transform="rotate(5,15,75)"/>
        <ellipse cx="30" cy="55" rx="4" ry="22" fill="#6a5a40" opacity="0.2" transform="rotate(10,30,55)"/>
        <ellipse cx="-25" cy="85" rx="4" ry="18" fill="#6a5a40" opacity="0.2" transform="rotate(-8,-25,85)"/>
    </g>

    <!-- Drifting fog layers -->
    <rect x="-200" y="500" width="2320" height="60" fill="url(#fog1)" opacity="0.4" style="animation: drift-right 25s ease-in-out infinite;"/>
    <rect x="-200" y="600" width="2320" height="80" fill="url(#fog2)" opacity="0.35" style="animation: drift-left 30s ease-in-out infinite;"/>
    <rect x="-200" y="750" width="2320" height="50" fill="url(#fog1)" opacity="0.25" style="animation: drift-right 20s ease-in-out infinite;"/>

    <!-- Scattered coins (floating) -->
    <g style="animation: float-coin 4s ease-in-out infinite;">
        <circle cx="300" cy="850" r="6" fill="#d4843e" opacity="0.12" stroke="#e8a04c" stroke-width="0.5" stroke-opacity="0.15"/>
    </g>
    <g style="animation: float-coin 5s ease-in-out 1s infinite;">
        <circle cx="1500" cy="900" r="5" fill="#d4843e" opacity="0.1" stroke="#e8a04c" stroke-width="0.5" stroke-opacity="0.12"/>
    </g>
    <g style="animation: float-coin 3.5s ease-in-out 0.5s infinite;">
        <circle cx="900" cy="950" r="7" fill="#d4843e" opacity="0.08" stroke="#e8a04c" stroke-width="0.5" stroke-opacity="0.1"/>
    </g>

    <!-- Candlestick pattern (subtle, like the hakama fabric) -->
    <g opacity="0.06">
        <!-- Green candles -->
        <rect x="200" y="920" width="4" height="30" fill="#4a8a4a" rx="1"/>
        <line x1="202" y1="910" x2="202" y2="960" stroke="#4a8a4a" stroke-width="1"/>
        <rect x="215" y="930" width="4" height="20" fill="#4a8a4a" rx="1"/>
        <line x1="217" y1="925" x2="217" y2="955" stroke="#4a8a4a" stroke-width="1"/>
        <!-- Red candles -->
        <rect x="230" y="925" width="4" height="25" fill="#c44b3f" rx="1"/>
        <line x1="232" y1="915" x2="232" y2="955" stroke="#c44b3f" stroke-width="1"/>
        <rect x="245" y="935" width="4" height="15" fill="#c44b3f" rx="1"/>
        <line x1="247" y1="928" x2="247" y2="958" stroke="#c44b3f" stroke-width="1"/>
        <!-- More green -->
        <rect x="260" y="920" width="4" height="25" fill="#4a8a4a" rx="1"/>
        <line x1="262" y1="912" x2="262" y2="950" stroke="#4a8a4a" stroke-width="1"/>

        <!-- Right side cluster -->
        <rect x="1600" y="930" width="4" height="20" fill="#4a8a4a" rx="1"/>
        <line x1="1602" y1="922" x2="1602" y2="955" stroke="#4a8a4a" stroke-width="1"/>
        <rect x="1615" y="925" width="4" height="28" fill="#c44b3f" rx="1"/>
        <line x1="1617" y1="918" x2="1617" y2="960" stroke="#c44b3f" stroke-width="1"/>
        <rect x="1630" y="935" width="4" height="18" fill="#4a8a4a" rx="1"/>
        <line x1="1632" y1="930" x2="1632" y2="958" stroke="#4a8a4a" stroke-width="1"/>
    </g>

    <!-- Grain overlay -->
    <rect width="1920" height="1080" filter="url(#grain)" opacity="0.4"/>
</svg>

<img src="bg.png" alt="" class="bg-watermark">

<!-- ============ LOADING ============ -->
<div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div style="color: var(--text-dim); font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase;">Loading dashboard...</div>
</div>

<!-- Level Up Overlay -->
<div class="levelup-overlay" id="levelupOverlay" style="display:none" onclick="dismissLevelUp()">
    <div class="levelup-content">
        <img class="levelup-pokemon" id="levelupSprite" src="" alt="">
        <div class="levelup-title" id="levelupTitle">EVOLUTION!</div>
        <div class="levelup-detail" id="levelupDetail"></div>
        <div class="levelup-pokename" id="levelupPokename"></div>
        <div class="levelup-tap">tap to continue</div>
    </div>
</div>

<!-- ============ MAIN CONTENT ============ -->
<div class="content">
    <div class="error-banner" id="errorBanner"></div>

    <div class="header">
        <div class="header-left">
            <img src="logo.png" alt="SPX" class="header-logo">
            <div>
                <h1><span>SPX</span> Trade</h1>
                <div class="header-sub">Stock Position Tracker</div>
            </div>
        </div>
        <div class="header-right">
            <span><span class="status-dot loading" id="statusDot"></span><span id="statusText">Connecting...</span></span>
            <span id="lastUpdate"></span>
            <button class="portfolio-btn" onclick="openPortfolioModal()">+ Portfolio</button>
            <button class="refresh-btn" onclick="fetchData()">Refresh</button>
        </div>
    </div>

    <!-- Quote Banner -->
    <div class="quote-banner" id="quoteBanner">
        <div class="quote-text" id="quoteText"></div>
        <div class="quote-author" id="quoteAuthor"></div>
    </div>

    <!-- Weekly Tasks -->
    <div class="weekly-tasks" id="weeklyTasks" style="display:none">
        <div class="weekly-tasks-list" id="weeklyTasksList"></div>
    </div>

    <!-- Quick Stats Bar -->
    <div class="stats-bar" id="statsBar">
        <div class="stat-card">
            <div class="stat-value" id="statOpen">-</div>
            <div class="stat-label">Open Positions</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statWinRate">-</div>
            <div class="stat-label">Win Rate</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statPnl">-</div>
            <div class="stat-label">Net P&L</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statToday">-</div>
            <div class="stat-label">Today's Signals</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="statStreak">-</div>
            <div class="stat-label">Current Streak</div>
        </div>
    </div>

    <!-- Action Needed -->
    <div class="action-section" id="actionSection">
        <div class="section-header">Action Needed <span class="count" id="actionCount">0</span></div>
        <div class="action-list" id="actionList"></div>
    </div>

    <!-- Open Trades -->
    <div class="section-header">Open Trades <span class="count" id="openCount">0</span></div>
    <div class="open-trades-filters">
        <button class="filter-btn active" onclick="setOpenFilter('all',this)">All</button>
        <button class="filter-btn" onclick="setOpenFilter('no-0x0',this)">No OxO</button>
        <button class="filter-btn" onclick="setOpenFilter('no-tp',this)">No TP</button>
        <button class="filter-btn need-4day-btn" onclick="setOpenFilter('need-4day',this)">Need 4 Day</button>
    </div>
    <div class="action-list" id="openTradesList" style="max-height:420px;overflow-y:auto">
        <div class="no-actions">No open trades right now.</div>
    </div>

    <!-- Ticker Grid -->
    <!-- Pokemon Scaling -->
    <div class="pokemon-section" id="pokemonSection">
        <div class="section-header" style="margin-top:2rem">Trader Level</div>
        <div class="pokemon-box" id="pokemonBox"></div>
    </div>

    <div class="section-header" style="margin-top:2rem">Tickers <span class="count" id="tickerCount">0</span></div>
    <div class="ticker-search-bar">
        <input type="text" id="tickerSearch" placeholder="Search tickers..." oninput="filterTickers()">
        <button id="tickerShowAll" onclick="toggleShowAll()">Show All</button>
    </div>
    <div class="ticker-grid" id="tickerGrid"></div>

    <!-- Bottom: Recent Signals + Performance -->
    <div class="bottom-grid">
        <div>
            <div class="section-header">Recent Signals <span class="count" id="signalCount">0</span></div>
            <div class="section-box" style="max-height:300px;overflow-y:auto">
                <table class="signals-table" id="signalsTable">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Ticker</th>
                            <th>Signal</th>
                            <th>Price</th>
                            <th>TF</th>
                            <th>RSI</th>
                        </tr>
                    </thead>
                    <tbody id="signalsBody"></tbody>
                </table>
            </div>
        </div>
        <div>
            <div class="section-header">Performance Summary</div>
            <div class="section-box">
                <div class="perf-grid" id="perfGrid"></div>
            </div>
        </div>
    </div>

    <!-- Graveyard Of Wins -->
    <div class="section-header" style="justify-content: center; border-left: none; padding-left: 0;">Graveyard Of Wins <span class="count" id="graveyardCount">0</span></div>
    <div class="graveyard" id="graveyard"></div>

    <!-- Omikuji Fortune -->
    <div class="omikuji-section">
        <div class="omikuji-slip" id="omikujiSlip" onclick="drawOmikuji()">
            <div class="omikuji-label">OMIKUJI</div>
            <div class="omikuji-icon">&#x304A;&#x307F;&#x304F;&#x3058;</div>
            <div class="omikuji-hint">Click to draw your fortune</div>
        </div>
        <div class="omikuji-result hidden" id="omikujiResult">
            <div class="omikuji-fortune" id="omikujiFortune"></div>
            <div class="omikuji-tip" id="omikujiTip"></div>
            <button class="refresh-btn" onclick="resetOmikuji()" style="margin-top:0.75rem">Draw Again</button>
        </div>
    </div>

    <div class="footer">SPX Trade Dashboard</div>
</div>

<!-- Portfolio Allocation Modal -->
<div class="modal-overlay" id="portfolioModal">
    <div class="modal-box">
        <div class="modal-title">Add to Portfolio</div>
        <input type="number" class="modal-input" id="portfolioAmount" placeholder="Enter amount ($)" min="1" oninput="previewAllocation()">
        <table class="modal-table" id="portfolioTable">
            <thead><tr><th>Ticker</th><th>Badge</th><th>Grade</th><th>Weight</th><th>%</th><th>$ Amount</th></tr></thead>
            <tbody id="portfolioBody"></tbody>
        </table>
        <div class="modal-buttons">
            <button class="modal-confirm" id="portfolioConfirm" onclick="confirmPortfolio()" disabled>Confirm</button>
            <button class="modal-cancel" onclick="closePortfolioModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
    // ====== CONFIG ======
    const API_URL = 'https://script.google.com/macros/s/AKfycbwVwBpJsq5kybfAuo8DpvODludwPehRWeT81bRe1PftdSuYCXv90FnewvIsZtCZIUv6Cg/exec?action=dashboard';
    const REFRESH_INTERVAL = 60000; // 60 seconds

    const BADGE_INFO = [
        { grade: 1,  name: 'Boulder',    icon: 'badges/Boulder_Badge.png',  multiplier: 1.0, weight: 0 },
        { grade: 2,  name: 'Cascade',    icon: 'badges/Cascade_Badge.png',  multiplier: 1.0, weight: 0 },
        { grade: 3,  name: 'Thunder',    icon: 'badges/Thunder_Badge.png',  multiplier: 1.0, weight: 5 },
        { grade: 4,  name: 'Rainbow',    icon: 'badges/Rainbow_Badge.png',  multiplier: 1.3, weight: 10 },
        { grade: 5,  name: 'Soul',       icon: 'badges/Soul_Badge.png',     multiplier: 1.5, weight: 15 },
        { grade: 6,  name: 'Marsh',      icon: 'badges/Marsh_Badge.png',    multiplier: 1.7, weight: 20 },
        { grade: 7,  name: 'Volcano',    icon: 'badges/Volcano_Badge.png',  multiplier: 2.0, weight: 25 },
        { grade: 8,  name: 'Earth',      icon: 'badges/Earth_Badge.png',    multiplier: 2.3, weight: 30 },
        { grade: 9,  name: 'Elite Four', icon: 'badges/master-ball.png',    multiplier: 2.5, weight: 35 },
        { grade: 10, name: 'Master',     icon: 'badges/master-ball.png',    multiplier: 3.0, weight: 40 }
    ];
    function getBadgeInfo(grade) { return BADGE_INFO.find(b => b.grade === grade) || BADGE_INFO[0]; }

    // ====== BACKTEST DATA (Feb 11, 2026  42 assets) ======
    const BACKTEST = {
        'AAPL':     { buy: { sl: 7, tp: 5, wr: 68.8, halfTp: 2.5 }, sell: null, note: 'Never short' },
        'AMD':      { buy: { sl: 12.5, tp: 13, wr: 56, halfTp: 6.5 }, sell: { sl: 16.5, tp: 6, wr: 75, halfTp: 3 }, note: 'Sell small edge' },
        'AMZN':     { buy: { sl: 12.5, tp: 8, wr: 70.7, halfTp: 4 }, sell: { sl: 16.5, tp: 8, wr: 81.4, halfTp: 4 }, note: 'Both work' },
        'BABA':     { buy: { sl: 11, tp: 9.5, wr: 57.7, halfTp: 4.75 }, sell: null, note: 'Never short' },
        'BOTZ':     { buy: { sl: 7, tp: 4, wr: 71.9, halfTp: 2 }, sell: { sl: 5, tp: 4, wr: 57.1, halfTp: 2 }, note: 'TP 4% both' },
        'CL1!':     { buy: { sl: 5, tp: 3, wr: 64.7, halfTp: 1.5 }, sell: { sl: 5, tp: 3, wr: 68.5, halfTp: 1.5 }, note: 'Both TP 3%' },
        'COIN':     { buy: null, sell: null, note: 'AVOID' },
        'COPPER':   { buy: { sl: 3.5, tp: 3, wr: 58.9, halfTp: 1.5 }, sell: { sl: 3.5, tp: 2, wr: 66.1, halfTp: 1 }, note: 'Buy-favored' },
        'GOOGL':    { buy: { sl: 5.5, tp: 6, wr: 61.8, halfTp: 3 }, sell: null, note: 'Buy-only' },
        'HOOD':     { buy: { sl: 13.5, tp: 10, wr: 68.7, halfTp: 5 }, sell: null, note: 'Never short' },
        'INTC':     { buy: { sl: 8, tp: 4, wr: 68.8, halfTp: 2 }, sell: { sl: 7.5, tp: 8, wr: 54.5, halfTp: 4 }, note: 'Sell-favored' },
        'ITA':      { buy: { sl: 5.5, tp: 3, wr: 70.1, halfTp: 1.5 }, sell: null, note: 'Never short' },
        'IWM':      { buy: { sl: 5, tp: 3, wr: 67.3, halfTp: 1.5 }, sell: { sl: 4.5, tp: 4, wr: 57.4, halfTp: 2 }, note: 'Buy-favored' },
        'MAGS':     { buy: { sl: 4.5, tp: 6, wr: 62.2, halfTp: 3 }, sell: null, note: 'Buy-only' },
        'META':     { buy: { sl: 7, tp: 6, wr: 64.5, halfTp: 3 }, sell: null, note: 'Buy-only' },
        'MSFT':     { buy: { sl: 6, tp: 5, wr: 59.6, halfTp: 2.5 }, sell: { sl: 5.5, tp: 5, wr: 61.9, halfTp: 2.5 }, note: 'SELL signals only' },
        'MSTR':     { buy: { sl: 12, tp: 15, wr: 53.5, halfTp: 7.5 }, sell: null, note: 'Small size, volatile' },
        'MU':       { buy: { sl: 11, tp: 10, wr: 62.2, halfTp: 5 }, sell: { sl: 14, tp: 8, wr: 63.3, halfTp: 4 }, note: null },
        'NFLX':     { buy: { sl: 9, tp: 10, wr: 61.4, halfTp: 5 }, sell: { sl: 13, tp: 8, wr: 71.7, halfTp: 4 }, note: null },
        'NG1!':     { buy: { sl: 7, tp: 6, wr: 59.6, halfTp: 3 }, sell: { sl: 8.5, tp: 7, wr: 57.8, halfTp: 3.5 }, note: null },
        'NLR':      { buy: { sl: 9.5, tp: 6, wr: 70.9, halfTp: 3 }, sell: { sl: 7, tp: 6, wr: 61.1, halfTp: 3 }, note: null },
        'NVDA':     { buy: { sl: 9, tp: 12, wr: 54.2, halfTp: 6 }, sell: null, note: 'Never short' },
        'ORCL':     { buy: { sl: 8, tp: 5, wr: 71.3, halfTp: 2.5 }, sell: { sl: 6, tp: 5, wr: 51.6, halfTp: 2.5 }, note: null },
        'PLATINUM': { buy: { sl: 3.5, tp: 3, wr: 55.9, halfTp: 1.5 }, sell: null, note: 'Buy-only, small edge' },
        'PLTR':     { buy: { sl: 10, tp: 10, wr: 63.4, halfTp: 5 }, sell: null, note: 'Never short' },
        'RIVN':     { buy: { sl: 16.5, tp: 12, wr: 60, halfTp: 6 }, sell: { sl: 18, tp: 10, wr: 75, halfTp: 5 }, note: '$5 size only' },
        'SILVER':   { buy: { sl: 3.5, tp: 4, wr: 54.4, halfTp: 2 }, sell: null, note: 'Buy-only' },
        'SMH':      { buy: { sl: 8, tp: 5, wr: 68.8, halfTp: 2.5 }, sell: null, note: 'Never short' },
        'TLT':      { buy: { sl: 3, tp: 3, wr: 54, halfTp: 1.5 }, sell: null, note: 'Buy-only, small edge' },
        'TSLA':     { buy: { sl: 10, tp: 10, wr: 59.1, halfTp: 5 }, sell: null, note: 'Never short' },
        'URNM':     { buy: { sl: 9, tp: 12, wr: 50.7, halfTp: 6 }, sell: null, note: 'Buy-only' },
        'USOIL':    { buy: { sl: 5, tp: 3, wr: 64.5, halfTp: 1.5 }, sell: { sl: 4, tp: 3, wr: 64.8, halfTp: 1.5 }, note: 'Sell > Buy' },
        'VOO':      { buy: { sl: 4, tp: 3, wr: 67.7, halfTp: 1.5 }, sell: null, note: 'Buy-only' },
        'XAUUSD':   { buy: { sl: 2, tp: 2, wr: 56.8, halfTp: 1 }, sell: null, note: 'REDUCE-only sell OK' },
        'XBI':      { buy: { sl: 7, tp: 4, wr: 70.2, halfTp: 2 }, sell: null, note: 'Buy-only' },
        'XLE':      { buy: { sl: 6, tp: 5, wr: 58.4, halfTp: 2.5 }, sell: { sl: 6, tp: 4, wr: 66.7, halfTp: 2 }, note: 'Both work' },
        'XLK':      { buy: { sl: 6, tp: 4, wr: 70.7, halfTp: 2 }, sell: null, note: 'REDUCE-only sell' },
        'XPDUSD':   { buy: { sl: 5, tp: 4, wr: 61.6, halfTp: 2 }, sell: { sl: 4, tp: 5, wr: 60.9, halfTp: 2.5 }, note: 'SELL-signals-only shorts' },
    };

    function getBacktest(ticker, side) {
        const t = ticker.toUpperCase();
        const entry = BACKTEST[t];
        if (!entry) return null;
        return entry[side] || null;
    }

    let refreshTimer = null;
    let allTickers = [];
    let showAllTickers = false;
    let openTradeFilter = 'all'; // all, no-0x0, no-tp
    const TICKER_LIMIT = 8;
    const LOGO_URL = 'https://financialmodelingprep.com/image-stock/';
    const TV_LOGO = 'https://s3-symbol-logo.tradingview.com/';
    const TV_LOGO_MAP = {
        'AAPL': 'apple', 'GOOGL': 'alphabet', 'AMD': 'advanced-micro-devices',
        'AMZN': 'amazon', 'BABA': 'alibaba', 'CL1!': 'crude-oil',
        'COIN': 'coinbase', 'COPPER': 'metal/copper', 'CRCL': 'circle',
        'CRWV': 'coreweave', 'HOOD': 'robinhood', 'INTC': 'intel',
        'META': 'meta-platforms', 'MSFT': 'microsoft', 'MSTR': 'microstrategy',
        'MU': 'micron-technology', 'NFLX': 'netflix', 'NG1!': 'natural-gas',
        'NVDA': 'nvidia', 'ORCL': 'oracle', 'PLATINUM': 'metal/platinum',
        'PLTR': 'palantir', 'RIVN': 'rivian', 'SILVER': 'silver',
        'SNDK': 'sandisk', 'TSLA': 'tesla', 'USAR': 'usa-rare-earth',
        'PALLADIUM': 'metal/palladium', 'USOIL': 'crude-oil'
    };
    function logoUrl(ticker) {
        const tv = TV_LOGO_MAP[ticker.toUpperCase()];
        if (tv) return TV_LOGO + tv + '.svg';
        return LOGO_URL + ticker + '.png';
    }

    // Signal label mapping
    function signalLabel(sig) {
        const s = (sig || '').toLowerCase();
        if (s === 'add') return 'BUY DCA';
        if (s === 'reduce') return 'SELL DCA';
        return s.toUpperCase();
    }
    function signalClass(sig) {
        const s = (sig || '').toLowerCase();
        if (s === 'add') return 'add';
        if (s === 'reduce') return 'reduce';
        return s;
    }

    // ====== PUSH NOTIFICATIONS ======
    const NOTIF_KEY = 'spx_known_signals';
    function getKnownSignals() {
        try { return JSON.parse(localStorage.getItem(NOTIF_KEY) || '[]'); } catch { return []; }
    }
    function setKnownSignals(keys) {
        localStorage.setItem(NOTIF_KEY, JSON.stringify(keys));
    }
    function checkNewSignals(data) {
        if (Notification.permission !== 'granted') return;
        const actions = (data.actionNeeded || []).filter(a => a.type === 'mark_action');
        const keys = actions.map(a => (a.ticker || '') + '|' + (a.signal || '') + '|' + (a.price || ''));
        const known = getKnownSignals();
        const newOnes = keys.filter(k => !known.includes(k));
        if (newOnes.length > 0 && known.length > 0) {
            newOnes.forEach(k => {
                const [ticker, sig] = k.split('|');
                if (navigator.serviceWorker && navigator.serviceWorker.ready) {
                    navigator.serviceWorker.ready.then(reg => {
                        reg.showNotification('Trade Alert: ' + ticker, {
                            body: (sig || '').toUpperCase() + ' signal',
                            icon: 'icon-192.png',
                            tag: k
                        });
                    });
                } else {
                    new Notification('Trade Alert: ' + ticker, {
                        body: (sig || '').toUpperCase() + ' signal',
                        icon: 'icon-192.png',
                        tag: k
                    });
                }
            });
        }
        setKnownSignals(keys);
    }
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }

    // ====== LOCAL SKIP TRACKING ======
    const ACTED_KEY = 'spx_acted_items';
    function getActedItems() {
        try { return JSON.parse(localStorage.getItem(ACTED_KEY) || '[]'); } catch { return []; }
    }
    function addActedItem(ticker, signal, price) {
        const items = getActedItems().filter(i => Date.now() - i.ts < 86400000);
        items.push({ t: ticker.toUpperCase(), s: signal.toLowerCase(), p: String(price), ts: Date.now() });
        localStorage.setItem(ACTED_KEY, JSON.stringify(items));
    }
    function isActed(ticker, signal, price) {
        return getActedItems().some(i => i.t === ticker.toUpperCase() && i.s === signal.toLowerCase() && i.p === String(price));
    }

    // ====== FETCH DATA ======
    async function fetchData() {
        const dot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        dot.className = 'status-dot loading';
        statusText.textContent = 'Fetching...';

        try {
            const resp = await fetch(API_URL);
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const data = await resp.json();

            if (data.status !== 'ok') throw new Error(data.message || 'Bad response');

            renderDashboard(data);
            checkNewSignals(data);

            dot.className = 'status-dot';
            statusText.textContent = 'Live';
            document.getElementById('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();
            document.getElementById('errorBanner').className = 'error-banner';
            document.getElementById('loading').className = 'loading-overlay hidden';
        } catch (err) {
            console.error('Dashboard error:', err);
            // Fall back to sample data for preview
            try { renderDashboard(SAMPLE_DATA); } catch(e) { console.error('Render error:', e); }
            dot.className = 'status-dot';
            statusText.textContent = 'Preview';
            document.getElementById('lastUpdate').textContent = 'Sample data';
            document.getElementById('errorBanner').className = 'error-banner';
            document.getElementById('loading').className = 'loading-overlay hidden';
        }

        // Schedule next refresh
        if (refreshTimer) clearTimeout(refreshTimer);
        refreshTimer = setTimeout(fetchData, REFRESH_INTERVAL);
    }

    // ====== RENDER ======
    function renderDashboard(data) {
        let { tickers, recentSignals, actionNeeded, stats } = data;

        // Filter out locally acted items
        actionNeeded = actionNeeded.filter(a => !isActed(a.ticker || '', a.signal || '', a.price || ''));

        // --- Quick Stats ---
        document.getElementById('statOpen').textContent = stats.openPositions || 0;
        const wrEl = document.getElementById('statWinRate');
        wrEl.textContent = stats.winRate || '0%';
        wrEl.className = 'stat-value' + (parseFloat(stats.winRate) >= 50 ? ' green' : parseFloat(stats.winRate) > 0 ? ' red' : '');

        const pnlEl = document.getElementById('statPnl');
        pnlEl.textContent = stats.netPnl || '$0.00';
        const pnlNum = parseFloat((stats.netPnl || '').replace('$', ''));
        pnlEl.className = 'stat-value' + (pnlNum >= 0 ? ' green' : ' red');

        document.getElementById('statToday').textContent = stats.todaySignals || 0;

        const streakEl = document.getElementById('statStreak');
        const streakStr = stats.currentStreak || '0';
        const streakDisplay = streakStr.includes('W') ? streakStr.replace('W', ' Win') : streakStr.includes('L') ? streakStr.replace('L', ' Loss') : streakStr;
        streakEl.textContent = streakDisplay;
        streakEl.className = 'stat-value' + (streakStr.includes('W') ? ' green' : streakStr.includes('L') ? ' red' : '');

        // --- Action Needed (only new signals, not outcomes) ---
        const actionList = document.getElementById('actionList');
        const actionCount = document.getElementById('actionCount');
        let newSignals = actionNeeded.filter(a => a.type === 'mark_action');
        actionCount.textContent = newSignals.length;
        if (newSignals.length === 0) {
            actionList.innerHTML = '<div class="no-actions">All caught up - no actions needed</div>';
        } else {
            actionList.innerHTML = newSignals.map((a, i) => {
                const id = 'action-' + i;
                const logo = logoUrl(a.ticker);
                const logoHtml = `<img src="${logo}" class="stock-logo" onerror="this.style.display='none';this.nextElementSibling.style.display='inline-flex'"><span class="stock-logo-fallback" style="display:none">${esc(a.ticker.slice(0,2))}</span>`;
                // Find effective size from tickers data
                const isBuy = ['buy','add'].includes((a.signal || '').toLowerCase());
                const matchTicker = tickers.find(t => t.ticker.toUpperCase() === a.ticker.toUpperCase());
                const effSize = matchTicker ? (isBuy ? matchTicker.buyEffectiveSize : matchTicker.sellEffectiveSize) : 0;
                const effSizeStr = effSize === 'SIT OUT' ? 'SIT OUT' : Number(effSize || 0).toFixed(2);
                const badge = matchTicker ? (isBuy ? matchTicker.buyBadge : matchTicker.sellBadge) : null;
                const badgeHtml = badge ? `<img src="${getBadgeInfo(badge.grade).icon}" class="badge-icon" style="margin-left:4px">` : '';
                const btSide = isBuy ? 'buy' : 'sell';
                const bt = getBacktest(a.ticker, btSide);
                const btEntry = BACKTEST[a.ticker.toUpperCase()];
                const btNote = btEntry ? btEntry.note : null;
                const p = Number(a.price);
                let btHtml;
                if (bt && p > 0) {
                    const slPrice = isBuy ? p * (1 - bt.sl / 100) : p * (1 + bt.sl / 100);
                    const tpPrice = isBuy ? p * (1 + bt.tp / 100) : p * (1 - bt.tp / 100);
                    const halfPrice = isBuy ? p * (1 + bt.halfTp / 100) : p * (1 - bt.halfTp / 100);
                    const fmt = v => v >= 100 ? v.toFixed(1) : v.toFixed(2);
                    btHtml = `<span style="color:var(--red-bright)">SL $${fmt(slPrice)} <span style="opacity:0.6;font-size:0.55rem">(${bt.sl}%)</span></span> &middot; <span style="color:var(--green-bright)">TP $${fmt(tpPrice)} <span style="opacity:0.6;font-size:0.55rem">(${bt.tp}%)</span></span> &middot; <span style="color:var(--text-dim)">Half TP 0x0 $${fmt(halfPrice)}</span>`;
                } else {
                    btHtml = btNote ? '' : `@ $${a.price}`;
                }
                const noteHtml = btNote ? ` &middot; <span style="color:var(--pumpkin-glow);font-weight:700">${esc(btNote)}</span>` : '';
                return `
                    <div class="action-item" id="${id}">
                        <div>
                            <div>${logoHtml}<span class="ticker-badge">${esc(a.ticker)}</span>${badgeHtml}<span class="signal-badge ${signalClass(a.signal)}" style="margin-left:0.5rem">${signalLabel(a.signal)}</span><span style="margin-left:0.5rem;font-size:0.65rem;color:var(--green-bright);font-weight:700">${effSizeStr !== 'SIT OUT' ? 'Enter at $' + effSizeStr : 'SIT OUT'}</span></div>
                            <div class="action-buttons">
                                <input type="text" class="entry-input" placeholder="Size $" id="${id}-size" value="${effSizeStr !== 'SIT OUT' ? effSizeStr : ''}">
                                <button class="action-btn entered" onclick="markAction('${esc(a.ticker)}','${esc(a.signal)}',${a.price},'Entered','${id}')">Entered</button>
                                <button class="action-btn skipped" onclick="markAction('${esc(a.ticker)}','${esc(a.signal)}',${a.price},'Skipped','${id}')">Skipped</button>
                            </div>
                        </div>
                        <div class="meta">${btHtml}${noteHtml}${a.timestamp ? ' &middot; ' + esc(a.timestamp) : ''}</div>
                    </div>`;
            }).join('');
        }

        // --- Open Trades (per-side)  exclude tickers still pending in Action Needed ---
        const pendingTickers = new Set(newSignals.map(a => a.ticker.toUpperCase()));
        let openTrades = [];
        tickers.forEach(t => {
            const bs = t.buyStatus || t.status || '';
            const ss = t.sellStatus || '';
            if ((bs === 'OPEN' || bs === 'NEW SIGNAL') && !pendingTickers.has(t.ticker.toUpperCase())) {
                openTrades.push({ ticker: t.ticker, lastSignal: t.buyLastSignal || 'buy', price: t.buyPrice || t.price, phase: t.buyPhase || t.phase, nextSize: t.buyNextSize != null ? t.buyNextSize : t.nextSize, status: bs, side: 'buy', outcome: t.buyOutcome || '', profitLocked: t.buyProfitLocked || 0 });
            }
            if ((ss === 'OPEN' || ss === 'NEW SIGNAL') && !pendingTickers.has(t.ticker.toUpperCase())) {
                openTrades.push({ ticker: t.ticker, lastSignal: t.sellLastSignal || 'sell', price: t.sellPrice || t.price, phase: t.sellPhase || '', nextSize: t.sellNextSize || 0, status: ss, side: 'sell', outcome: t.sellOutcome || '', profitLocked: t.sellProfitLocked || 0 });
            }
        });
        renderOpenTrades(openTrades);

        // --- Ticker Grid (sort by most recent signal first) ---
        const signalOrder = {};
        recentSignals.forEach((s, i) => {
            const tk = s.ticker.toUpperCase();
            if (!(tk in signalOrder)) signalOrder[tk] = i;
        });
        tickers.sort((a, b) => {
            const ai = signalOrder[a.ticker] !== undefined ? signalOrder[a.ticker] : 9999;
            const bi = signalOrder[b.ticker] !== undefined ? signalOrder[b.ticker] : 9999;
            return ai - bi;
        });
        allTickers = tickers;
        document.getElementById('tickerCount').textContent = tickers.length;
        renderTickerGrid();

        // --- Recent Signals ---
        document.getElementById('signalCount').textContent = recentSignals.length;
        const tbody = document.getElementById('signalsBody');
        tbody.innerHTML = recentSignals.map(s => `
            <tr>
                <td>${esc(s.timestamp)}</td>
                <td style="font-weight:700;color:var(--cream)">${esc(s.ticker)}</td>
                <td><span class="signal-badge ${s.signal}">${esc(s.signal)}</span></td>
                <td>$${Number(s.price || 0).toFixed(2)}</td>
                <td>${esc(s.timeframe || '-')}</td>
                <td>${s.rsi != null ? Number(s.rsi).toFixed(1) : '-'}</td>
            </tr>
        `).join('');

        // --- Graveyard Of Wins ---
        renderVictories(data);

        // --- Performance Summary ---
        const perfGrid = document.getElementById('perfGrid');
        perfGrid.innerHTML = `
            <div class="perf-item">
                <div class="perf-val">${stats.totalTrades}</div>
                <div class="perf-label">Total Trades</div>
            </div>
            <div class="perf-item">
                <div class="perf-val" style="color:${parseFloat(stats.winRate) >= 50 ? 'var(--green-bright)' : 'var(--red-bright)'}">${stats.winRate}</div>
                <div class="perf-label">Win Rate</div>
            </div>
            <div class="perf-item">
                <div class="perf-val glow-green" style="color:var(--green-bright)">${stats.totalProfit}</div>
                <div class="perf-label">Total Profit</div>
            </div>
            <div class="perf-item">
                <div class="perf-val glow-red" style="color:var(--red-bright)">${stats.totalLost}</div>
                <div class="perf-label">Total Lost</div>
            </div>
            <div class="perf-item">
                <div class="perf-val glow-green" style="color:var(--green-bright)">${stats.bestWinStreak} Win</div>
                <div class="perf-label">Best Win Streak</div>
            </div>
            <div class="perf-item">
                <div class="perf-val glow-red" style="color:var(--red-bright)">${stats.worstLossStreak} Loss</div>
                <div class="perf-label">Worst Loss Streak</div>
            </div>
            <div class="perf-item">
                <div class="perf-val">${stats.bestTicker}</div>
                <div class="perf-label">Best Ticker</div>
            </div>
            <div class="perf-item">
                <div class="perf-val">${stats.worstTicker}</div>
                <div class="perf-label">Worst Ticker</div>
            </div>
        `;

        // --- Pokemon Scaling ---
        renderPokemon(stats);
    }

    // ====== SIDE FLIP ======
    function flipSide(cardId, side) {
        const card = document.getElementById(cardId);
        if (!card) return;

        const raw = side === 'sell' ? card.dataset.sellData : card.dataset.buyData;
        if (!raw) return;
        const data = JSON.parse(raw);
        card.dataset.side = side;

        // Toggle buttons
        const btns = card.querySelectorAll('.side-toggle button');
        btns[0].className = side === 'buy' ? 'active-buy' : '';
        btns[1].className = side === 'sell' ? 'active-sell' : '';

        // Status badge
        const statusEl = card.querySelector('.ticker-status');
        if (statusEl) {
            const sc = (data.status || 'IDLE').replace(/\s+/g, '_');
            statusEl.className = 'ticker-status ' + sc;
            statusEl.textContent = data.status || 'IDLE';
        }

        // Badge
        const badgeEl = card.querySelector('.side-badge');
        if (badgeEl && data.badge) {
            const bi2 = getBadgeInfo(data.badge.grade || 1);
            const multLabel2 = data.badge.multiplier > 1 ? `<span class="badge-multiplier">&times;${data.badge.multiplier}</span>` : '';
            badgeEl.innerHTML = `<span class="badge-label">${esc(bi2.name)}</span>${multLabel2}`;
        }
        const badgeIcon = card.querySelector('.badge-icon');
        if (badgeIcon && data.badge) {
            const bi3 = getBadgeInfo(data.badge.grade || 1);
            badgeIcon.src = bi3.icon;
            badgeIcon.title = bi3.name + ' Badge (Grade ' + bi3.grade + ')';
        }

        // Signal badge
        const sigEl = card.querySelector('.side-signal');
        if (sigEl) sigEl.innerHTML = '<span class="signal-badge ' + signalClass(data.lastSignal) + '" style="font-size:0.55rem;padding:2px 6px">' + signalLabel(data.lastSignal) + '</span>';

        // Price
        const priceEl = card.querySelector('.side-price');
        if (priceEl) priceEl.textContent = data.price ? '$' + Number(data.price).toFixed(2) : '-';

        // Base size
        const baseEl = card.querySelector('.side-base');
        if (baseEl) baseEl.textContent = '$' + Number(data.base || 0).toFixed(2);

        // Effective size
        const nextEl = card.querySelector('.side-next');
        if (nextEl) nextEl.innerHTML = data.effectiveSize === 'SIT OUT' ? '<span class="red">SIT OUT</span>' : '$' + Number(data.effectiveSize || 0).toFixed(2);

        // Locked profit
        const lockedEl = card.querySelector('.side-locked');
        if (lockedEl) {
            lockedEl.textContent = Number(data.locked) > 0 ? '$' + Number(data.locked).toFixed(2) : '$0.00';
            lockedEl.className = 'side-locked' + (Number(data.locked) > 0 ? ' green' : '');
        }

        // Stop-outs
        const stopsEl = card.querySelector('.side-stops');
        if (stopsEl) {
            stopsEl.textContent = data.stopouts || 0;
            stopsEl.className = 'side-stops' + (Number(data.stopouts) > 0 ? ' red' : '');
        }

        // Phase + action
        const phaseEl = card.querySelector('.ticker-phase');
        if (phaseEl) phaseEl.textContent = data.phase || 'No data';
        const actionEl = card.querySelector('.ticker-action');
        if (actionEl) actionEl.textContent = data.nextAction || '';
    }

    // ====== HELPERS ======
    function esc(str) {
        const d = document.createElement('div');
        d.textContent = str || '';
        return d.innerHTML;
    }

    // ====== API WRITE FUNCTIONS ======
    const POST_URL = 'https://script.google.com/macros/s/AKfycbwVwBpJsq5kybfAuo8DpvODludwPehRWeT81bRe1PftdSuYCXv90FnewvIsZtCZIUv6Cg/exec';

    function buildUpdateUrl(params) {
        const url = new URL(POST_URL);
        url.searchParams.set('action', 'update_position');
        for (const [k, v] of Object.entries(params)) {
            if (v !== '' && v != null) url.searchParams.set(k, v);
        }
        return url.toString();
    }

    // Fire-and-forget GET that works on mobile (bypasses CORS redirect issues)
    function fireGet(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = resolve;
            img.onerror = resolve; // Apps Script returns JSON not an image, so onerror = success
            setTimeout(() => resolve(), 5000); // 5s safety timeout
            img.src = url;
        });
    }

    async function markAction(ticker, signal, price, value, elemId) {
        const sizeInput = document.getElementById(elemId + '-size');
        const entrySize = sizeInput ? sizeInput.value : '';
        const el = document.getElementById(elemId);

        // Instant hide via localStorage
        addActedItem(ticker, signal, price);
        el.style.transition = 'opacity 0.3s';
        el.style.opacity = '0';
        setTimeout(() => el.style.display = 'none', 300);

        // Fire server update in background via img GET (mobile-safe)
        fireGet(buildUpdateUrl({ ticker, signal, price, field: 'action', value, entrySize }))
            .then(() => setTimeout(fetchData, 3000));
    }

    async function markOutcome(ticker, signal, price, value, elemId) {
        const el = document.getElementById(elemId);
        const profitInput = document.getElementById(elemId + '-profit');
        const inputVal = profitInput ? parseFloat(profitInput.value) || 0 : 0;
        const badge = document.getElementById(elemId + '-badge');
        const closeBtn = document.getElementById(elemId + '-close');
        const prevTotal = parseFloat(el.dataset.pnl) || 0;

        if (value === 'Won') {
            // Close trade as TP Hit with profit
            const grandTotal = prevTotal + inputVal;
            el.querySelectorAll('.action-btn').forEach(b => b.disabled = true);
            await fireGet(buildUpdateUrl({ ticker, signal, price, field: 'outcome', value: 'TP Hit', profitLocked: grandTotal.toFixed(2) }));
            badge.style.display = 'inline-block';
            badge.className = 'pnl-badge positive';
            badge.textContent = '+$' + grandTotal.toFixed(2);
            el.style.opacity = '0';
            setTimeout(() => el.remove(), 600);
            setTimeout(fetchData, 3000);
            return;
        }

        if (value === '0x0') {
            // Safe  stop moved to breakeven, trade still open
            el.dataset.status = '0x0';
            el.style.borderLeftColor = '#1f6feb';
            badge.style.display = 'inline-block';
            badge.className = 'pnl-badge neutral';
            badge.textContent = 'OxO';
            // Persist 0x0 status to sheet via img GET (mobile-safe)
            fireGet(buildUpdateUrl({ ticker, signal, price, field: 'outcome', value: '0x0' }));
            return;
        }

        // Lost  stopped out, final close, send to sheet
        const grandTotal = prevTotal + inputVal;
        el.querySelectorAll('.action-btn').forEach(b => b.disabled = true);
        await fireGet(buildUpdateUrl({ ticker, signal, price, field: 'outcome', value: 'Stopped Out', profitLocked: grandTotal.toFixed(2) }));
        badge.style.display = 'inline-block';
        badge.className = 'pnl-badge negative';
        badge.textContent = grandTotal < 0 ? '-$' + Math.abs(grandTotal).toFixed(2) : '$' + grandTotal.toFixed(2);
        el.style.opacity = '0';
        setTimeout(() => el.remove(), 600);
        setTimeout(fetchData, 3000);
    }

    // Close trade  finalizes with accumulated profit, sends to sheet
    async function closeTrade(ticker, signal, price, elemId) {
        const el = document.getElementById(elemId);
        const grandTotal = parseFloat(el.dataset.pnl) || 0;
        const badge = document.getElementById(elemId + '-badge');
        el.querySelectorAll('.action-btn').forEach(b => b.disabled = true);
        await fireGet(buildUpdateUrl({ ticker, signal, price, field: 'outcome', value: 'TP Hit', profitLocked: grandTotal.toFixed(2) }));
        badge.style.display = 'inline-block';
        badge.className = 'pnl-badge positive';
        badge.textContent = '+$' + grandTotal.toFixed(2);
        el.style.opacity = '0';
        setTimeout(() => el.remove(), 600);
        setTimeout(fetchData, 3000);
    }

    // ====== PORTFOLIO ALLOCATION MODAL ======
    function openPortfolioModal() {
        document.getElementById('portfolioModal').classList.add('active');
        document.getElementById('portfolioAmount').value = '';
        document.getElementById('portfolioAmount').focus();
        previewAllocation();
    }
    function closePortfolioModal() {
        document.getElementById('portfolioModal').classList.remove('active');
    }
    function previewAllocation() {
        const amount = parseFloat(document.getElementById('portfolioAmount').value) || 0;
        const body = document.getElementById('portfolioBody');
        const confirmBtn = document.getElementById('portfolioConfirm');

        // Build allocation preview from allTickers data
        let eligible = [];
        let ineligible = [];
        allTickers.forEach(t => {
            const badge = t.buyBadge || { grade: 1, name: 'Boulder', weight: 0 };
            const base = Number(t.buyBase || t.base || 30);
            if (badge.grade >= 3) {
                eligible.push({ ticker: t.ticker, badge: badge.name, grade: badge.grade, weight: badge.weight, base });
            } else {
                ineligible.push({ ticker: t.ticker, badge: badge.name, grade: badge.grade });
            }
        });

        // Diminishing returns: absorb_rate = 1000 / (1000 + base)
        eligible.forEach(e => { e.absorbRate = 1000 / (1000 + e.base); e.effWeight = e.weight * e.absorbRate; });
        const totalEffWeight = eligible.reduce((s, e) => s + e.effWeight, 0);

        let html = '';
        eligible.forEach(e => {
            const pct = totalEffWeight > 0 ? (e.effWeight / totalEffWeight) : 0;
            const alloc = Math.round(amount * pct * 100) / 100;
            const bi = getBadgeInfo(e.grade);
            html += `<tr>
                <td style="font-weight:700;color:var(--cream)">${esc(e.ticker)}</td>
                <td><img src="${bi.icon}" class="badge-icon"> ${esc(e.badge)}</td>
                <td>${e.grade}</td>
                <td>${e.weight}</td>
                <td>${(pct * 100).toFixed(1)}%</td>
                <td class="alloc-amount">$${alloc.toFixed(2)}</td>
            </tr>`;
        });
        ineligible.forEach(e => {
            const bi = getBadgeInfo(e.grade);
            html += `<tr class="unproven">
                <td>${esc(e.ticker)}</td>
                <td><img src="${bi.icon}" class="badge-icon"> ${esc(e.badge)}</td>
                <td>${e.grade}</td>
                <td>-</td>
                <td>-</td>
                <td style="font-size:0.55rem;color:var(--text-dim)">Unproven</td>
            </tr>`;
        });

        body.innerHTML = html;
        confirmBtn.disabled = amount <= 0 || eligible.length === 0;
    }
    async function confirmPortfolio() {
        const amount = parseFloat(document.getElementById('portfolioAmount').value) || 0;
        if (amount <= 0) return;
        const confirmBtn = document.getElementById('portfolioConfirm');
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Allocating...';

        try {
            const url = POST_URL + '?action=add_portfolio&amount=' + encodeURIComponent(amount);
            const resp = await fetch(url);
            const data = await resp.json();
            if (data.status === 'ok') {
                confirmBtn.textContent = 'Done!';
                confirmBtn.style.background = 'var(--green-candle)';
                setTimeout(() => {
                    closePortfolioModal();
                    confirmBtn.textContent = 'Confirm';
                    confirmBtn.style.background = '';
                    fetchData();
                }, 1500);
            } else {
                alert('Error: ' + (data.message || 'Unknown error'));
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirm';
            }
        } catch (err) {
            alert('Failed: ' + err.message);
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Confirm';
        }
    }

    // ====== ACTION NEEDED OUTCOME (simple, sends directly to sheet) ======
    async function markActionOutcome(ticker, signal, price, value, elemId) {
        const profitInput = document.getElementById(elemId + '-profit');
        const profitLocked = profitInput ? profitInput.value : '';
        const el = document.getElementById(elemId);
        el.querySelectorAll('.action-btn').forEach(b => b.disabled = true);
        await fireGet(buildUpdateUrl({ ticker, signal, price, field: 'outcome', value, profitLocked }));
        const color = value === 'TP Hit' ? 'var(--green-candle)' : value === 'Stopped Out' ? 'var(--red-candle)' : '#1f6feb';
        el.style.borderColor = color;
        el.style.opacity = '0.5';
        el.innerHTML = '<div><span class="ticker-badge">' + esc(ticker) + '</span><span class="message">' + value.toUpperCase() + (profitLocked ? ' ($' + profitLocked + ' locked)' : '') + '</span></div>';
        setTimeout(fetchData, 2000);
    }

    // ====== OPEN TRADE FILTERS ======
    function setOpenFilter(filter, btn) {
        openTradeFilter = filter;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        filterOpenTrades();
    }
    function filterOpenTrades() {
        document.querySelectorAll('#openTradesList .action-item').forEach(el => {
            const status = (el.dataset.status || '').toLowerCase();
            if (openTradeFilter === 'no-0x0' && status === '0x0') {
                el.style.display = 'none';
            } else if (openTradeFilter === 'no-tp' && status === 'tp') {
                el.style.display = 'none';
            } else {
                el.style.display = '';
            }
        });
    }

    // ====== EMPTY FALLBACK (shows when Apps Script not yet deployed) ======
    const SAMPLE_DATA = {
        status: 'ok',
        tickers: [],
        recentSignals: [],
        actionNeeded: [],
        stats: {
            totalTrades: 0, wins: 0, losses: 0, winRate: '0%',
            netPnl: '$0', totalProfit: '$0', totalLost: '$0',
            openPositions: 0, todaySignals: 0, bestWinStreak: 0,
            worstLossStreak: 0, currentStreak: '-',
            bestTicker: '-', worstTicker: '-'
        }
    };

    // ====== OPEN TRADES RENDERING ======
    function renderOpenTrades(trades) {
        const el = document.getElementById('openTradesList');
        document.getElementById('openCount').textContent = trades.length;
        if (trades.length === 0) {
            el.innerHTML = '<div class="no-actions">No open trades right now.</div>';
            return;
        }
        el.innerHTML = trades.map((t, i) => {
            const id = 'open-' + i;
            const logo = logoUrl(t.ticker);
            const pnl = Number(t.profitLocked || 0);
            const outcome = (t.outcome || '').toLowerCase();
            const initStatus = outcome === '0x0' ? '0x0' : (pnl > 0 ? 'tp' : '');
            const initBorder = outcome === '0x0' ? 'border-left-color:#1f6feb' : (pnl > 0 ? 'border-left-color:var(--green-candle)' : '');
            const badgeDisplay = (outcome === '0x0' || pnl > 0) ? 'inline-block' : 'none';
            const badgeClass = outcome === '0x0' ? 'pnl-badge neutral' : (pnl > 0 ? 'pnl-badge positive' : 'pnl-badge neutral');
            const badgeText = outcome === '0x0' ? 'OxO' : (pnl > 0 ? 'TP +$' + pnl.toFixed(2) : '');
            const closeDisplay = pnl > 0 ? 'inline-block' : 'none';
            return `
                <div class="action-item" id="${id}" data-pnl="${pnl}" data-status="${initStatus}" style="${initBorder}">
                    <div>
                        <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.5rem">
                            <img src="${logo}" class="stock-logo" onerror="this.style.display='none';this.nextElementSibling.style.display='inline-flex'" style="margin-right:0">
                            <span class="stock-logo-fallback" style="display:none;margin-right:0">${esc(t.ticker.slice(0,2))}</span>
                            <span class="ticker-badge" style="margin-right:0">${esc(t.ticker)}</span>
                            <span class="signal-badge ${signalClass(t.lastSignal)}" style="font-size:0.4rem;padding:1px 4px;opacity:0.7">${signalLabel(t.lastSignal)}</span>
                            <span class="${badgeClass}" id="${id}-badge" style="display:${badgeDisplay};font-size:0.4rem;padding:1px 4px;opacity:0.7;margin-left:auto">${badgeText}</span>
                        </div>
                        <div class="action-buttons">
                            <input type="text" class="entry-input" placeholder="P&L $" id="${id}-profit">
                            <button class="action-btn won" onclick="markOutcome('${esc(t.ticker)}','${esc(t.lastSignal || '')}',${t.price || 0},'Won','${id}')">Won</button>
                            <button class="action-btn lost" onclick="markOutcome('${esc(t.ticker)}','${esc(t.lastSignal || '')}',${t.price || 0},'Lost','${id}')">Lost</button>
                            <button class="action-btn zero" onclick="markOutcome('${esc(t.ticker)}','${esc(t.lastSignal || '')}',${t.price || 0},'0x0','${id}')">OxO</button>
                            <button class="action-btn four-day-btn" id="${id}-4day" onclick="toggle4DayCheck('${esc(t.ticker)}','${id}')">4 Day</button>
                        </div>
                    </div>
                    <div class="meta">${esc(t.phase || '')}  $${Number(t.price || 0).toFixed(2)}  Next: $${t.nextSize === 'SIT OUT' ? 'SIT OUT' : Number(t.nextSize || 0).toFixed(2)}</div>
                </div>`;
        }).join('');
    }

    // ====== TICKER LINKS (editable, saved to localStorage) ======
    // ====== TICKER GRID RENDERING ======
    function renderTickerCard(t, i) {
        const tid = 'ticker-' + i;
        const activeSide = (t.lastSignal === 'sell' || t.lastSignal === 'reduce') ? 'sell' : 'buy';

        // Build per-side data objects
        const buyBadge = t.buyBadge || { grade: 1, name: 'Boulder', multiplier: 1.0 };
        const sellBadge = t.sellBadge || { grade: 1, name: 'Boulder', multiplier: 1.0 };
        const buyData = {
            base: Number(t.buyBase || t.base || 30),
            phase: t.buyPhase || t.phase || 'No trades',
            nextSize: t.buyNextSize != null ? t.buyNextSize : (activeSide === 'buy' ? t.nextSize : 0),
            locked: Number(t.buyLocked || (activeSide === 'buy' ? t.locked : 0)),
            stopouts: Number(t.buyStopouts || (activeSide === 'buy' ? t.stopouts : 0)),
            status: t.buyStatus || (activeSide === 'buy' ? t.status : 'IDLE'),
            nextAction: t.buyNextAction || (activeSide === 'buy' ? t.nextAction : ''),
            lastSignal: t.buyLastSignal || (activeSide === 'buy' ? t.lastSignal : ''),
            price: t.buyPrice || (activeSide === 'buy' ? t.price : 0),
            badge: buyBadge,
            effectiveSize: t.buyEffectiveSize || 0
        };
        const sellData = {
            base: Number(t.sellBase || 0),
            phase: t.sellPhase || 'No trades',
            nextSize: t.sellNextSize != null ? t.sellNextSize : (activeSide === 'sell' ? t.nextSize : 0),
            locked: Number(t.sellLocked || (activeSide === 'sell' ? t.locked : 0)),
            stopouts: Number(t.sellStopouts || (activeSide === 'sell' ? t.stopouts : 0)),
            status: t.sellStatus || (activeSide === 'sell' ? t.status : 'IDLE'),
            nextAction: t.sellNextAction || (activeSide === 'sell' ? t.nextAction : ''),
            lastSignal: t.sellLastSignal || (activeSide === 'sell' ? t.lastSignal : ''),
            price: t.sellPrice || (activeSide === 'sell' ? t.price : 0),
            badge: sellBadge,
            effectiveSize: t.sellEffectiveSize || 0
        };

        const sd = activeSide === 'sell' ? sellData : buyData;
        const statusClass = (sd.status || 'IDLE').replace(/\s+/g, '_');
        const lockedClass = sd.locked > 0 ? 'green' : '';
        const stopClass = sd.stopouts > 0 ? 'red' : '';
        const bi = getBadgeInfo(sd.badge ? sd.badge.grade : 1);
        const multLabel = sd.badge && sd.badge.multiplier > 1 ? `<span class="badge-multiplier">&times;${sd.badge.multiplier}</span>` : '';
        const effSize = sd.effectiveSize;

        return `
            <div class="ticker-card" id="${tid}" data-side="${activeSide}"
                 data-buy-data='${JSON.stringify(buyData).replace(/'/g, "&#39;")}'
                 data-sell-data='${JSON.stringify(sellData).replace(/'/g, "&#39;")}'>
                <div class="ticker-card-header">
                    <div style="display:flex;align-items:center;gap:0.5rem">
                        <img src="${logoUrl(t.ticker)}" class="stock-logo" onerror="this.style.display='none';this.nextElementSibling.style.display='inline-flex'"><span class="stock-logo-fallback" style="display:none">${esc(t.ticker.slice(0,2))}</span>
                        <span class="ticker-name">${esc(t.ticker)}</span>
                        <img src="${bi.icon}" class="badge-icon" title="${bi.name} Badge (Grade ${bi.grade})">
                        <span class="ticker-status ${statusClass}">${esc(sd.status || 'IDLE')}</span>
                    </div>
                    <div class="side-toggle">
                        <button class="${activeSide === 'buy' ? 'active-buy' : ''}" onclick="flipSide('${tid}','buy')">Buy</button>
                        <button class="${activeSide === 'sell' ? 'active-sell' : ''}" onclick="flipSide('${tid}','sell')">Sell</button>
                    </div>
                </div>
                <dl class="ticker-detail">
                    <dt>Badge</dt><dd class="side-badge"><span class="badge-label">${esc(bi.name)}</span>${multLabel}</dd>
                    <dt>Last Signal</dt><dd class="side-signal"><span class="signal-badge ${signalClass(sd.lastSignal)}" style="font-size:0.55rem;padding:2px 6px">${signalLabel(sd.lastSignal)}</span></dd>
                    <dt>Price</dt><dd class="side-price">${sd.price ? '$' + Number(sd.price).toFixed(2) : '-'}</dd>
                    <dt>Base Size</dt><dd class="side-base">$${sd.base.toFixed(2)}</dd>
                    <dt>Effective Size</dt><dd class="side-next">${effSize === 'SIT OUT' ? '<span class="red">SIT OUT</span>' : '$' + Number(effSize || 0).toFixed(2)}</dd>
                    <dt>Locked Profit</dt><dd class="side-locked ${lockedClass}">${sd.locked > 0 ? '$' + sd.locked.toFixed(2) : '$0.00'}</dd>
                    <dt>Stop-outs</dt><dd class="side-stops ${stopClass}">${sd.stopouts || 0}</dd>
                </dl>
                <div class="ticker-phase">${esc(sd.phase || 'No data')}</div>
                ${sd.nextAction ? '<div class="ticker-action">' + esc(sd.nextAction) + '</div>' : ''}
                <div class="ticker-links">
                    <a class="ticker-link tv" href="${getTickerLink(t.ticker, 'tv')}" target="_blank">TradingView</a>
                    <a class="ticker-link hl" href="${getTickerLink(t.ticker, 'hl')}" target="_blank">Hyperliquid</a>
                    <button class="ticker-link" onclick="editLinks('${esc(t.ticker)}')" title="Edit links">&#9998;</button>
                </div>
            </div>
        `;
    }

    function renderTickerGrid(filtered) {
        const grid = document.getElementById('tickerGrid');
        const btn = document.getElementById('tickerShowAll');
        const search = document.getElementById('tickerSearch').value.trim().toUpperCase();
        let tickers = filtered || allTickers;

        if (search) {
            // When searching, show all matches
            tickers = allTickers.filter(t => t.ticker.toUpperCase().includes(search));
            btn.textContent = `${tickers.length} match${tickers.length !== 1 ? 'es' : ''}`;
            btn.classList.remove('active');
        } else if (!showAllTickers && tickers.length > TICKER_LIMIT) {
            // Default: show most recent 8
            tickers = tickers.slice(0, TICKER_LIMIT);
            btn.textContent = `Show All (${allTickers.length})`;
            btn.classList.remove('active');
        } else {
            btn.textContent = 'Show Recent';
            btn.classList.add('active');
        }

        grid.innerHTML = tickers.map((t, i) => renderTickerCard(t, i)).join('');
    }

    function filterTickers() {
        showAllTickers = false;
        renderTickerGrid();
    }

    function toggleShowAll() {
        const search = document.getElementById('tickerSearch');
        if (search.value.trim()) {
            search.value = '';
        }
        showAllTickers = !showAllTickers;
        renderTickerGrid();
    }

    // ====== TICKER LINKS ======
    const TV_EXCHANGE_MAP = {
        'AAPL':'NASDAQ','AMD':'NASDAQ','AMZN':'NASDAQ','BABA':'NYSE','BOTZ':'NASDAQ',
        'CL1!':'NYMEX','COIN':'NASDAQ','COPPER':'CAPITALCOM','CRCL':'NYSE','CRWV':'NASDAQ',
        'GOOGL':'NASDAQ','HOOD':'NASDAQ','INTC':'NASDAQ','ITA':'CBOE','IWM':'AMEX',
        'MAGS':'CBOE','META':'NASDAQ','MSFT':'NASDAQ','MSTR':'NASDAQ','MU':'NASDAQ',
        'NFLX':'NASDAQ','NG1!':'NYMEX','NLR':'AMEX','NVDA':'NASDAQ','ORCL':'NYSE',
        'PLATINUM':'CAPITALCOM','PLTR':'NASDAQ','RIVN':'NASDAQ','SILVER':'CAPITALCOM',
        'SMH':'NASDAQ','SNDK':'NASDAQ','TLT':'NASDAQ','TSLA':'NASDAQ','URNM':'AMEX',
        'USAR':'NASDAQ','USOIL':'TVC','VOO':'AMEX','XBI':'AMEX','XLE':'AMEX',
        'XLK':'AMEX','XPDUSD':'OANDA'
    };
    const DEFAULT_TV = ticker => {
        const ex = TV_EXCHANGE_MAP[ticker.toUpperCase()] || 'NASDAQ';
        return `https://www.tradingview.com/chart/rVtW3nNy/?symbol=${encodeURIComponent(ex)}%3A${encodeURIComponent(ticker.toUpperCase())}`;
    };
    const HL_TICKER_MAP = {
        'AAPL':'flx:APPL','AMD':'flx:AMD','AMZN':'flx:AMZN','BABA':'flx:BABA','BOTZ':'flx:ROBOT',
        'CL1!':'flx:OIL','COIN':'flx:COIN','COPPER':'flx:COPPER','CRCL':'flx:CRCL','CRWV':'flx:CRWV',
        'GOOGL':'flx:GOOGL','HOOD':'flx:HOOD','INTC':'flx:INTC','ITA':'flx:DEFENSE','IWM':'flx:SMALL2000',
        'MAGS':'flx:MAG7','META':'flx:META','MSFT':'flx:MSFT','MSTR':'flx:MSTR','MU':'flx:MU',
        'NFLX':'flx:NFLX','NG1!':'flx:NATGAS','NLR':'flx:NUCLEAR','NVDA':'flx:NVDA','ORCL':'flx:ORCL',
        'PLATINUM':'flx:PLATINUM','PLTR':'flx:PLTR','RIVN':'xyz:RIVN','SILVER':'flx:SILVER',
        'SMH':'flx:SEMIS','SNDK':'flx:SNDK','TLT':'flx:USBOND','TSLA':'flx:TSLA','URNM':'flx:URNM',
        'USAR':'flx:USAR','USOIL':'flx:USOIL','VOO':'flx:USA500','XBI':'flx:BIOTECH','XLE':'flx:ENERGY',
        'XLK':'flx:INFOTECH','XPDUSD':'flx:PALLADIUM'
    };
    const DEFAULT_HL = ticker => {
        const path = HL_TICKER_MAP[ticker.toUpperCase()] || 'flx:' + ticker.toUpperCase();
        return `https://app.hyperliquid.xyz/trade/${encodeURIComponent(path)}`;
    };

    function getTickerLinks() {
        try { return JSON.parse(localStorage.getItem('spx_ticker_links') || '{}'); }
        catch { return {}; }
    }

    function saveTickerLinks(links) {
        localStorage.setItem('spx_ticker_links', JSON.stringify(links));
    }

    function getTickerLink(ticker, platform) {
        const links = getTickerLinks();
        const key = ticker.toUpperCase();
        if (links[key] && links[key][platform]) return links[key][platform];
        return platform === 'tv' ? DEFAULT_TV(ticker) : DEFAULT_HL(ticker);
    }

    function editLinks(ticker) {
        const key = ticker.toUpperCase();
        const links = getTickerLinks();
        const current = links[key] || {};

        const tvUrl = prompt(
            `TradingView URL for ${key}:\n(Leave empty for default)`,
            current.tv || DEFAULT_TV(ticker)
        );
        if (tvUrl === null) return; // cancelled

        const hlUrl = prompt(
            `Hyperliquid URL for ${key}:\n(Leave empty for default)`,
            current.hl || DEFAULT_HL(ticker)
        );
        if (hlUrl === null) return;

        if (!links[key]) links[key] = {};
        links[key].tv = tvUrl || '';
        links[key].hl = hlUrl || '';

        // Clean up empty entries
        if (!links[key].tv) delete links[key].tv;
        if (!links[key].hl) delete links[key].hl;
        if (Object.keys(links[key]).length === 0) delete links[key];

        saveTickerLinks(links);
        fetchData(); // re-render with new links
    }

    // ====== VICTORY GARDEN ======
    function renderVictories(data) {
        const garden = document.getElementById('graveyard');
        const countEl = document.getElementById('graveyardCount');
        const wins = (data.closedTrades || []).map(t => ({
            ticker: t.ticker,
            profit: Number(t.profit || 0).toFixed(2),
            date: t.date || ''
        }));
        countEl.textContent = wins.length;
        if (wins.length === 0) {
            garden.innerHTML = '<div class="victory-empty">No wins buried yet  your first victory will rise here</div>';
            return;
        }
        garden.innerHTML = wins.map(w => `
            <div class="victory-stone">
                <div class="stone-marker">
                    <svg viewBox="0 0 90 130" xmlns="http://www.w3.org/2000/svg">
                        <!-- Ground -->
                        <rect x="0" y="115" width="90" height="15" fill="#2a3828" rx="1"/>
                        <path d="M0,115 Q15,112 30,115 Q45,111 60,115 Q75,112 90,115" fill="#3a4a35" opacity="0.6"/>

                        <!-- Gravestone body  woodblock style with bold outlines -->
                        <path d="M18,50 L18,108 L72,108 L72,50 Q72,18 45,18 Q18,18 18,50 Z" fill="#4a6068" stroke="#1a1815" stroke-width="2.5"/>
                        <!-- Inner border line (woodblock double-line style) -->
                        <path d="M23,52 L23,103 L67,103 L67,52 Q67,26 45,26 Q23,26 23,52 Z" fill="none" stroke="#5a7a80" stroke-width="1" opacity="0.5"/>

                        <!-- Moss & lichen patches (ukiyo-e organic shapes) -->
                        <ellipse cx="25" cy="55" rx="8" ry="5" fill="#5a8a5a" opacity="0.5"/>
                        <ellipse cx="62" cy="65" rx="7" ry="4" fill="#6a9a5a" opacity="0.4"/>
                        <ellipse cx="30" cy="95" rx="6" ry="3" fill="#5a8a5a" opacity="0.35"/>
                        <ellipse cx="55" cy="45" rx="5" ry="4" fill="#4a7a4a" opacity="0.3"/>
                        <circle cx="22" cy="40" r="3" fill="#6a9a5a" opacity="0.25"/>

                        <!-- Pedestal base -->
                        <rect x="12" y="105" width="66" height="12" rx="1" fill="#3a4a50" stroke="#1a1815" stroke-width="2"/>
                        <line x1="14" y1="108" x2="76" y2="108" stroke="#5a7a80" stroke-width="0.5" opacity="0.4"/>

                        <!-- Engraved text -->
                        <text x="45" y="58" text-anchor="middle" font-family="'Noto Serif JP',serif" font-size="14" font-weight="900" fill="#e8d5a8" stroke="#1a1815" stroke-width="0.3">${esc(w.ticker)}</text>
                        <text x="45" y="76" text-anchor="middle" font-family="'Space Mono',monospace" font-size="10" font-weight="700" fill="#8ae08a" stroke="#1a1815" stroke-width="0.2">+$${w.profit}</text>
                        <text x="45" y="92" text-anchor="middle" font-family="'Noto Serif JP',serif" font-size="7" fill="#c8d8d0" opacity="0.8">R.I.P.</text>

                        <!-- Grass & reeds (susuki style) -->
                        <path d="M5,118 Q8,100 10,85" stroke="#6a9a50" stroke-width="1.2" fill="none" opacity="0.7"/>
                        <path d="M8,118 Q12,102 13,90" stroke="#5a8a48" stroke-width="1" fill="none" opacity="0.6"/>
                        <path d="M2,118 Q4,105 3,92" stroke="#7aaa58" stroke-width="1" fill="none" opacity="0.5"/>
                        <!-- Plume -->
                        <ellipse cx="10" cy="83" rx="2.5" ry="8" fill="#a8b878" opacity="0.5" transform="rotate(-5,10,83)"/>
                        <ellipse cx="3" cy="90" rx="2" ry="7" fill="#a8b878" opacity="0.4" transform="rotate(3,3,90)"/>

                        <!-- Right grass -->
                        <path d="M82,118 Q84,104 86,88" stroke="#6a9a50" stroke-width="1.2" fill="none" opacity="0.7"/>
                        <path d="M85,118 Q82,106 80,93" stroke="#5a8a48" stroke-width="1" fill="none" opacity="0.6"/>
                        <ellipse cx="86" cy="86" rx="2.5" ry="8" fill="#a8b878" opacity="0.45" transform="rotate(5,86,86)"/>

                        <!-- Fallen leaves (ukiyo-e style) -->
                        <ellipse cx="15" cy="116" rx="3" ry="1.5" fill="#d4843e" opacity="0.6" transform="rotate(20,15,116)"/>
                        <ellipse cx="70" cy="117" rx="2.5" ry="1.2" fill="#c47830" opacity="0.5" transform="rotate(-15,70,117)"/>
                        <ellipse cx="40" cy="118" rx="2" ry="1" fill="#e8a04c" opacity="0.4" transform="rotate(30,40,118)"/>

                        <!-- Firefly / spirit wisp -->
                        <circle cx="75" cy="40" r="2" fill="#e8d5a8" opacity="0.5">
                            <animate attributeName="opacity" values="0.2;0.6;0.2" dur="3s" repeatCount="indefinite"/>
                        </circle>
                        <circle cx="75" cy="40" r="4" fill="#e8d5a8" opacity="0.15">
                            <animate attributeName="opacity" values="0.05;0.2;0.05" dur="3s" repeatCount="indefinite"/>
                        </circle>
                    </svg>
                </div>
                <div class="stone-date">${esc(w.date)}</div>
            </div>
        `).join('');
    }

    // ====== OMIKUJI ======
    const OMIKUJI = [
        { level: 'great', label: 'Great Blessing', tip: 'The market favors the prepared mind today. Trust your setups and size with confidence.' },
        { level: 'great', label: 'Great Blessing', tip: 'A strong trend awaits you. Let winners run and do not cut them early.' },
        { level: 'good', label: 'Good Fortune', tip: 'Patience will be rewarded. Wait for the signal  do not chase.' },
        { level: 'good', label: 'Good Fortune', tip: 'Your discipline is your edge. Stick to the plan and profits will follow.' },
        { level: 'good', label: 'Good Fortune', tip: 'A reversal brings opportunity. Watch RSI for the trendline break.' },
        { level: 'small', label: 'Small Blessing', tip: 'Small gains compound into great wealth. Do not underestimate the power of consistency.' },
        { level: 'small', label: 'Small Blessing', tip: 'Today is for learning. Review your past trades and find the pattern.' },
        { level: 'small', label: 'Small Blessing', tip: 'Protect your capital. A smaller position today means a bigger one tomorrow.' },
        { level: 'uncertain', label: 'Uncertain Fortune', tip: 'The market is choppy. Sometimes the best trade is no trade at all.' },
        { level: 'uncertain', label: 'Uncertain Fortune', tip: 'Beware of overtrading. Step away from the screen and return with fresh eyes.' },
        { level: 'great', label: 'Great Blessing', tip: 'The pumpkin trader smiles upon you. Multiple setups align  be ready to act.' },
        { level: 'good', label: 'Good Fortune', tip: 'Cut the losers early and you will find the winners take care of themselves.' },
        { level: 'small', label: 'Small Blessing', tip: 'A DCA add at the right moment turns a good trade into a great one.' },
        { level: 'uncertain', label: 'Uncertain Fortune', tip: 'Three stops in a row means sit out. The market will be there tomorrow.' },
        { level: 'great', label: 'Great Blessing', tip: 'Your locked profits are seeds. Reinvest them wisely and watch them grow.' },
    ];

    function drawOmikuji() {
        const slip = document.getElementById('omikujiSlip');
        const result = document.getElementById('omikujiResult');
        const fortune = document.getElementById('omikujiFortune');
        const tip = document.getElementById('omikujiTip');

        const o = OMIKUJI[Math.floor(Math.random() * OMIKUJI.length)];
        fortune.textContent = o.label;
        fortune.className = 'omikuji-fortune ' + o.level;
        tip.textContent = o.tip;

        slip.style.display = 'none';
        result.className = 'omikuji-result';
    }

    function resetOmikuji() {
        document.getElementById('omikujiSlip').style.display = 'flex';
        document.getElementById('omikujiResult').className = 'omikuji-result hidden';
    }

    // ====== QUOTES ======
    const QUOTES = [
        { text: "The stock market is a device for transferring money from the impatient to the patient.", author: "Warren Buffett" },
        { text: "The trend is your friend until the end when it bends.", author: "Ed Seykota" },
        { text: "It's not whether you're right or wrong, but how much money you make when you're right and how much you lose when you're wrong.", author: "George Soros" },
        { text: "The goal of a successful trader is to make the best trades. Money is secondary.", author: "Alexander Elder" },
        { text: "Cut your losses short and let your profits run.", author: "Jesse Livermore" },
        { text: "Markets can remain irrational longer than you can remain solvent.", author: "John Maynard Keynes" },
        { text: "In trading, the impossible happens about twice a year.", author: "Henri M. Simoes" },
        { text: "The elements of good trading are: cutting losses, cutting losses, and cutting losses.", author: "Ed Seykota" },
        { text: "Risk comes from not knowing what you are doing.", author: "Warren Buffett" },
        { text: "Plan your trade and trade your plan.", author: "Richard Dennis" },
        { text: "The market is never wrong  opinions often are.", author: "Jesse Livermore" },
        { text: "Amateurs think about how much money they can make. Professionals think about how much money they could lose.", author: "Jack Schwager" },
        { text: "You don't need to know what is going to happen next in order to make money.", author: "Mark Douglas" },
        { text: "The most important thing in making money is not letting your losses get out of hand.", author: "Marty Schwartz" },
        { text: "Win or lose, everybody gets what they want out of the market.", author: "Ed Seykota" },
        { text: "There is a time to go long, a time to go short, and a time to go fishing.", author: "Jesse Livermore" },
        { text: "The hard work in trading comes in the preparation. The actual process of trading should be effortless.", author: "Jack Schwager" },
        { text: "Every battle is won before it is fought.", author: "Sun Tzu" },
        { text: "Discipline is the bridge between goals and accomplishment.", author: "Jim Rohn" },
        { text: "Do not anticipate and move without market confirmation.", author: "Jesse Livermore" }
    ];

    function showQuote() {
        const q = QUOTES[Math.floor(Math.random() * QUOTES.length)];
        const textEl = document.getElementById('quoteText');
        const authEl = document.getElementById('quoteAuthor');
        textEl.style.opacity = '0';
        authEl.style.opacity = '0';
        setTimeout(() => {
            textEl.textContent = '"' + q.text + '"';
            authEl.textContent = ' ' + q.author;
            textEl.style.opacity = '0.7';
            authEl.style.opacity = '0.6';
        }, 300);
    }
    showQuote();

    // ====== WEEKLY TASKS ======
    function getMonday() {
        const d = new Date(); d.setHours(0,0,0,0);
        const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        d.setDate(diff); return d.toISOString().slice(0,10);
    }
    function getCheckedTasks() { try { return JSON.parse(localStorage.getItem('spx_weekly_todos_' + getMonday()) || '[]'); } catch(e) { return []; } }
    function setCheckedTasks(arr) { localStorage.setItem('spx_weekly_todos_' + getMonday(), JSON.stringify(arr)); }
    async function fetchWeeklyTasks() {
        try {
            const resp = await fetch(POST_URL + '?action=tasks');
            const data = await resp.json();
            if (data.status === 'ok' && data.tasks && data.tasks.length > 0) renderWeeklyTasks(data.tasks);
        } catch(e) { console.error('Weekly tasks error:', e); }
    }
    function renderWeeklyTasks(tasks) {
        const checked = getCheckedTasks();
        const allDone = tasks.every((_, i) => checked.includes(i));
        const container = document.getElementById('weeklyTasks');
        if (allDone) { container.style.display = 'none'; return; }
        container.style.display = '';
        document.getElementById('weeklyTasksList').innerHTML = tasks.map((task, i) => {
            const isDone = checked.includes(i);
            return `<div class="weekly-task-item${isDone ? ' checked' : ''}" onclick="toggleTask(${i}, ${JSON.stringify(tasks).replace(/"/g, '&quot;')})">
                <div class="weekly-task-checkbox"></div>
                <span class="task-text">${esc(task)}</span>
            </div>`;
        }).join('');
    }
    function toggleTask(idx, tasks) {
        const checked = getCheckedTasks();
        const pos = checked.indexOf(idx);
        if (pos === -1) checked.push(idx); else checked.splice(pos, 1);
        setCheckedTasks(checked);
        renderWeeklyTasks(tasks);
    }

    // ====== 4-DAY CHECK ======
    function get4DayStates() { try { return JSON.parse(localStorage.getItem('spx_4day_checks') || '{}'); } catch(e) { return {}; } }
    function set4DayStates(obj) { localStorage.setItem('spx_4day_checks', JSON.stringify(obj)); }
    function toggle4DayCheck(ticker, cardId) {
        const states = get4DayStates();
        states[ticker] = Date.now();
        set4DayStates(states);
        update4DayBtn(ticker, cardId);
        updateNeed4DayCount();
    }
    function update4DayBtn(ticker, cardId) {
        const btn = document.getElementById(cardId + '-4day');
        if (!btn) return;
        const states = get4DayStates();
        const ts = states[ticker];
        if (!ts) {
            // Auto-start timer
            states[ticker] = Date.now();
            set4DayStates(states);
        }
        const elapsed = Date.now() - (states[ticker] || Date.now());
        const fourDays = 4 * 24 * 60 * 60 * 1000;
        const remaining = fourDays - elapsed;
        if (remaining <= 0) {
            btn.className = 'action-btn four-day-btn needs-check';
            btn.textContent = 'CHECK!';
        } else {
            btn.className = 'action-btn four-day-btn checked';
            const hoursLeft = Math.ceil(remaining / (1000 * 60 * 60));
            if (hoursLeft > 24) {
                btn.textContent = Math.ceil(hoursLeft / 24) + 'd';
            } else {
                btn.textContent = hoursLeft + 'h';
            }
        }
    }
    function restore4DayStates() {
        document.querySelectorAll('#openTradesList .action-item').forEach(el => {
            const ticker = el.querySelector('.ticker-badge')?.textContent;
            if (ticker) update4DayBtn(ticker, el.id);
        });
        updateNeed4DayCount();
    }
    function updateNeed4DayCount() {
        const states = get4DayStates();
        const fourDays = 4 * 24 * 60 * 60 * 1000;
        let count = 0;
        document.querySelectorAll('#openTradesList .action-item').forEach(el => {
            const ticker = el.querySelector('.ticker-badge')?.textContent;
            if (ticker && states[ticker]) {
                const remaining = fourDays - (Date.now() - states[ticker]);
                if (remaining <= 0) count++;
            }
        });
        const btn = document.querySelector('.need-4day-btn');
        if (btn) {
            btn.textContent = count > 0 ? 'Need 4 Day (' + count + ')' : 'Need 4 Day';
            btn.classList.toggle('has-alerts', count > 0);
        }
    }

    // Override filterOpenTrades to handle need-4day
    const _origFilterOpen = filterOpenTrades;
    filterOpenTrades = function() {
        const states = get4DayStates();
        const fourDays = 4 * 24 * 60 * 60 * 1000;
        document.querySelectorAll('#openTradesList .action-item').forEach(el => {
            const status = (el.dataset.status || '').toLowerCase();
            const ticker = el.querySelector('.ticker-badge')?.textContent;
            if (openTradeFilter === 'no-0x0' && status === '0x0') {
                el.style.display = 'none';
            } else if (openTradeFilter === 'no-tp' && status === 'tp') {
                el.style.display = 'none';
            } else if (openTradeFilter === 'need-4day') {
                const ts = ticker && states[ticker];
                const needsCheck = ts && (fourDays - (Date.now() - ts)) <= 0;
                el.style.display = needsCheck ? '' : 'none';
            } else {
                el.style.display = '';
            }
        });
    };

    // Hook into renderOpenTrades to restore 4-day states after render
    const _origRenderOpen = renderOpenTrades;
    renderOpenTrades = function(trades) {
        _origRenderOpen(trades);
        setTimeout(restore4DayStates, 50);
    };

    // ====== POKEMON SCALING ======
    const POKE_SPRITE = id => `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;

    // Location backgrounds from FireRed/LeafGreen
    const LOCATION_BG = {
        pallet:   'https://archives.bulbagarden.net/media/upload/7/77/Pallet_Town_FRLG.png',
        pewter:   'https://archives.bulbagarden.net/media/upload/c/cf/Pewter_City_FRLG.png',
        cerulean: 'https://archives.bulbagarden.net/media/upload/0/0b/Cerulean_City_FRLG.png',
        vermilion:'https://archives.bulbagarden.net/media/upload/8/8d/Vermilion_City_FRLG.png',
        celadon:  'https://archives.bulbagarden.net/media/upload/e/ee/Celadon_City_FRLG.png',
        fuchsia:  'https://archives.bulbagarden.net/media/upload/d/d0/Fuchsia_City_FRLG.png',
        cinnabar: 'https://archives.bulbagarden.net/media/upload/6/65/Cinnabar_Island_FRLG.png',
        indigo:   'https://archives.bulbagarden.net/media/upload/2/26/Indigo_Plateau_FRLG.png'
    };

    const POKEMON_LEVELS = [
        // Pallet Town  Starters
        { min:     0, pokemon: 'Bulbasaur',   pokeId:   1, location: 'pallet' },
        { min:     4, pokemon: 'Ivysaur',     pokeId:   2, location: 'pallet' },
        { min:     7, pokemon: 'Venusaur',    pokeId:   3, location: 'pallet' },
        { min:    11, pokemon: 'Charmander',  pokeId:   4, location: 'pallet' },
        { min:    14, pokemon: 'Charmeleon',  pokeId:   5, location: 'pallet' },
        { min:    20, pokemon: 'Charizard',   pokeId:   6, location: 'pallet' },
        { min:    27, pokemon: 'Squirtle',    pokeId:   7, location: 'pallet' },
        { min:    35, pokemon: 'Wartortle',   pokeId:   8, location: 'pallet' },
        { min:    45, pokemon: 'Blastoise',   pokeId:   9, location: 'pallet' },
        // Viridian to Pewter  Early Routes
        { min:    57, pokemon: 'Caterpie',    pokeId:  10, location: 'pewter' },
        { min:    69, pokemon: 'Metapod',     pokeId:  11, location: 'pewter' },
        { min:    78, pokemon: 'Butterfree',  pokeId:  12, location: 'pewter' },
        { min:    96, pokemon: 'Weedle',      pokeId:  13, location: 'pewter' },
        { min:   106, pokemon: 'Kakuna',      pokeId:  14, location: 'pewter' },
        { min:   128, pokemon: 'Beedrill',    pokeId:  15, location: 'pewter' },
        { min:   142, pokemon: 'Pidgey',      pokeId:  16, location: 'pewter' },
        { min:   156, pokemon: 'Pidgeotto',   pokeId:  17, location: 'pewter' },
        { min:   186, pokemon: 'Pidgeot',     pokeId:  18, location: 'pewter' },
        { min:   204, pokemon: 'Rattata',     pokeId:  19, location: 'pewter' },
        { min:   234, pokemon: 'Raticate',    pokeId:  20, location: 'pewter' },
        { min:   252, pokemon: 'Spearow',     pokeId:  21, location: 'pewter' },
        { min:   278, pokemon: 'Fearow',      pokeId:  22, location: 'pewter' },
        { min:   318, pokemon: 'Ekans',       pokeId:  23, location: 'pewter' },
        { min:   344, pokemon: 'Arbok',       pokeId:  24, location: 'pewter' },
        { min:   379, pokemon: 'Pikachu',     pokeId:  25, location: 'pewter' },
        { min:   419, pokemon: 'Raichu',      pokeId:  26, location: 'pewter' },
        { min:   459, pokemon: 'Sandshrew',   pokeId:  27, location: 'pewter' },
        { min:   485, pokemon: 'Sandslash',   pokeId:  28, location: 'pewter' },
        { min:   513, pokemon: 'Nidoran\u2640', pokeId: 29, location: 'pewter' },
        { min:   548, pokemon: 'Nidorina',    pokeId:  30, location: 'pewter' },
        { min:   598, pokemon: 'Nidoqueen',   pokeId:  31, location: 'pewter' },
        { min:   628, pokemon: 'Nidoran\u2642', pokeId: 32, location: 'pewter' },
        { min:   673, pokemon: 'Nidorino',    pokeId:  33, location: 'pewter' },
        { min:   738, pokemon: 'Nidoking',    pokeId:  34, location: 'pewter' },
        // Cerulean to Vermilion  Gym Challenge
        { min:   773, pokemon: 'Clefairy',    pokeId:  35, location: 'cerulean' },
        { min:   853, pokemon: 'Clefable',    pokeId:  36, location: 'cerulean' },
        { min:   893, pokemon: 'Vulpix',      pokeId:  37, location: 'cerulean' },
        { min:   943, pokemon: 'Ninetales',   pokeId:  38, location: 'cerulean' },
        { min:  1028, pokemon: 'Jigglypuff',  pokeId:  39, location: 'cerulean' },
        { min:  1073, pokemon: 'Wigglytuff',  pokeId:  40, location: 'cerulean' },
        { min:  1143, pokemon: 'Zubat',       pokeId:  41, location: 'vermilion' },
        { min:  1203, pokemon: 'Golbat',      pokeId:  42, location: 'vermilion' },
        { min:  1278, pokemon: 'Oddish',      pokeId:  43, location: 'vermilion' },
        { min:  1353, pokemon: 'Gloom',       pokeId:  44, location: 'vermilion' },
        { min:  1443, pokemon: 'Vileplume',   pokeId:  45, location: 'vermilion' },
        { min:  1533, pokemon: 'Paras',       pokeId:  46, location: 'vermilion' },
        { min:  1613, pokemon: 'Parasect',    pokeId:  47, location: 'vermilion' },
        { min:  1678, pokemon: 'Venonat',     pokeId:  48, location: 'vermilion' },
        { min:  1773, pokemon: 'Venomoth',    pokeId:  49, location: 'vermilion' },
        { min:  1828, pokemon: 'Diglett',     pokeId:  50, location: 'vermilion' },
        { min:  1918, pokemon: 'Dugtrio',     pokeId:  51, location: 'vermilion' },
        { min:  1973, pokemon: 'Meowth',      pokeId:  52, location: 'vermilion' },
        { min:  2053, pokemon: 'Persian',     pokeId:  53, location: 'vermilion' },
        { min:  2183, pokemon: 'Psyduck',     pokeId:  54, location: 'vermilion' },
        { min:  2258, pokemon: 'Golduck',     pokeId:  55, location: 'vermilion' },
        { min:  2323, pokemon: 'Mankey',      pokeId:  56, location: 'vermilion' },
        { min:  2423, pokemon: 'Primeape',    pokeId:  57, location: 'vermilion' },
        { min:  2523, pokemon: 'Growlithe',   pokeId:  58, location: 'vermilion' },
        { min:  2663, pokemon: 'Arcanine',    pokeId:  59, location: 'vermilion' },
        { min:  2783, pokemon: 'Poliwag',     pokeId:  60, location: 'vermilion' },
        { min:  2923, pokemon: 'Poliwhirl',   pokeId:  61, location: 'vermilion' },
        { min:  3008, pokemon: 'Poliwrath',   pokeId:  62, location: 'vermilion' },
        { min:  3158, pokemon: 'Abra',        pokeId:  63, location: 'vermilion' },
        { min:  3298, pokemon: 'Kadabra',     pokeId:  64, location: 'vermilion' },
        { min:  3448, pokemon: 'Alakazam',    pokeId:  65, location: 'vermilion' },
        // Celadon to Fuchsia  Building Power
        { min:  3618, pokemon: 'Machop',      pokeId:  66, location: 'celadon' },
        { min:  3768, pokemon: 'Machoke',     pokeId:  67, location: 'celadon' },
        { min:  3863, pokemon: 'Machamp',     pokeId:  68, location: 'celadon' },
        { min:  4003, pokemon: 'Bellsprout',  pokeId:  69, location: 'celadon' },
        { min:  4183, pokemon: 'Weepinbell',  pokeId:  70, location: 'celadon' },
        { min:  4353, pokemon: 'Victreebel',  pokeId:  71, location: 'celadon' },
        { min:  4543, pokemon: 'Tentacool',   pokeId:  72, location: 'celadon' },
        { min:  4633, pokemon: 'Tentacruel',  pokeId:  73, location: 'celadon' },
        { min:  4743, pokemon: 'Geodude',     pokeId:  74, location: 'celadon' },
        { min:  4923, pokemon: 'Graveler',    pokeId:  75, location: 'celadon' },
        { min:  5053, pokemon: 'Golem',       pokeId:  76, location: 'celadon' },
        { min:  5233, pokemon: 'Ponyta',      pokeId:  77, location: 'celadon' },
        { min:  5443, pokemon: 'Rapidash',    pokeId:  78, location: 'celadon' },
        { min:  5653, pokemon: 'Slowpoke',    pokeId:  79, location: 'celadon' },
        { min:  5793, pokemon: 'Slowbro',     pokeId:  80, location: 'celadon' },
        { min:  6013, pokemon: 'Magnemite',   pokeId:  81, location: 'fuchsia' },
        { min:  6233, pokemon: 'Magneton',    pokeId:  82, location: 'fuchsia' },
        { min:  6473, pokemon: "Farfetch\u2019d", pokeId: 83, location: 'fuchsia' },
        { min:  6583, pokemon: 'Doduo',       pokeId:  84, location: 'fuchsia' },
        { min:  6693, pokemon: 'Dodrio',      pokeId:  85, location: 'fuchsia' },
        { min:  6913, pokemon: 'Seel',        pokeId:  86, location: 'fuchsia' },
        { min:  7163, pokemon: 'Dewgong',     pokeId:  87, location: 'fuchsia' },
        { min:  7383, pokemon: 'Grimer',      pokeId:  88, location: 'fuchsia' },
        { min:  7503, pokemon: 'Muk',         pokeId:  89, location: 'fuchsia' },
        { min:  7733, pokemon: 'Shellder',    pokeId:  90, location: 'fuchsia' },
        { min:  7923, pokemon: 'Cloyster',    pokeId:  91, location: 'fuchsia' },
        { min:  8083, pokemon: 'Gastly',      pokeId:  92, location: 'fuchsia' },
        { min:  8323, pokemon: 'Haunter',     pokeId:  93, location: 'fuchsia' },
        { min:  8603, pokemon: 'Gengar',      pokeId:  94, location: 'fuchsia' },
        { min:  8833, pokemon: 'Onix',        pokeId:  95, location: 'fuchsia' },
        { min:  8993, pokemon: 'Drowzee',     pokeId:  96, location: 'fuchsia' },
        { min:  9263, pokemon: 'Hypno',       pokeId:  97, location: 'fuchsia' },
        { min:  9483, pokemon: 'Krabby',      pokeId:  98, location: 'fuchsia' },
        { min:  9653, pokemon: 'Kingler',     pokeId:  99, location: 'fuchsia' },
        // Cinnabar Island  Scaling Up
        { min:  9943, pokemon: 'Voltorb',     pokeId: 100, location: 'cinnabar' },
        { min: 10103, pokemon: 'Electrode',   pokeId: 101, location: 'cinnabar' },
        { min: 10373, pokemon: 'Exeggcute',   pokeId: 102, location: 'cinnabar' },
        { min: 10523, pokemon: 'Exeggutor',   pokeId: 103, location: 'cinnabar' },
        { min: 10773, pokemon: 'Cubone',      pokeId: 104, location: 'cinnabar' },
        { min: 10993, pokemon: 'Marowak',     pokeId: 105, location: 'cinnabar' },
        { min: 11203, pokemon: 'Hitmonlee',   pokeId: 106, location: 'cinnabar' },
        { min: 11413, pokemon: 'Hitmonchan',  pokeId: 107, location: 'cinnabar' },
        { min: 11713, pokemon: 'Lickitung',   pokeId: 108, location: 'cinnabar' },
        { min: 11973, pokemon: 'Koffing',     pokeId: 109, location: 'cinnabar' },
        { min: 12183, pokemon: 'Weezing',     pokeId: 110, location: 'cinnabar' },
        { min: 12353, pokemon: 'Rhyhorn',     pokeId: 111, location: 'cinnabar' },
        { min: 12533, pokemon: 'Rhydon',      pokeId: 112, location: 'cinnabar' },
        { min: 12883, pokemon: 'Chansey',     pokeId: 113, location: 'cinnabar' },
        { min: 13073, pokemon: 'Tangela',     pokeId: 114, location: 'cinnabar' },
        { min: 13343, pokemon: 'Kangaskhan',  pokeId: 115, location: 'cinnabar' },
        { min: 13613, pokemon: 'Horsea',      pokeId: 116, location: 'cinnabar' },
        { min: 13893, pokemon: 'Seadra',      pokeId: 117, location: 'cinnabar' },
        { min: 14123, pokemon: 'Goldeen',     pokeId: 118, location: 'cinnabar' },
        { min: 14373, pokemon: 'Seaking',     pokeId: 119, location: 'cinnabar' },
        { min: 14723, pokemon: 'Staryu',      pokeId: 120, location: 'cinnabar' },
        { min: 14903, pokemon: 'Starmie',     pokeId: 121, location: 'cinnabar' },
        { min: 15278, pokemon: 'Mr. Mime',    pokeId: 122, location: 'cinnabar' },
        { min: 15468, pokemon: 'Scyther',     pokeId: 123, location: 'cinnabar' },
        { min: 15728, pokemon: 'Jynx',        pokeId: 124, location: 'cinnabar' },
        { min: 15998, pokemon: 'Electabuzz',  pokeId: 125, location: 'cinnabar' },
        { min: 16268, pokemon: 'Magmar',      pokeId: 126, location: 'cinnabar' },
        { min: 16668, pokemon: 'Pinsir',      pokeId: 127, location: 'cinnabar' },
        { min: 17043, pokemon: 'Tauros',      pokeId: 128, location: 'cinnabar' },
        { min: 17343, pokemon: 'Magikarp',    pokeId: 129, location: 'cinnabar' },
        { min: 17743, pokemon: 'Gyarados',    pokeId: 130, location: 'cinnabar' },
        // Victory Road  Elite Territory
        { min: 18193, pokemon: 'Lapras',      pokeId: 131, location: 'indigo' },
        { min: 18523, pokemon: 'Ditto',       pokeId: 132, location: 'indigo' },
        { min: 18787, pokemon: 'Eevee',       pokeId: 133, location: 'indigo' },
        { min: 19227, pokemon: 'Vaporeon',    pokeId: 134, location: 'indigo' },
        { min: 19694, pokemon: 'Jolteon',     pokeId: 135, location: 'indigo' },
        { min: 20002, pokemon: 'Flareon',     pokeId: 136, location: 'indigo' },
        { min: 20310, pokemon: 'Porygon',     pokeId: 137, location: 'indigo' },
        { min: 20596, pokemon: 'Omanyte',     pokeId: 138, location: 'indigo' },
        { min: 20827, pokemon: 'Omastar',     pokeId: 139, location: 'indigo' },
        { min: 21212, pokemon: 'Kabuto',      pokeId: 140, location: 'indigo' },
        { min: 21679, pokemon: 'Kabutops',    pokeId: 141, location: 'indigo' },
        { min: 22009, pokemon: 'Aerodactyl',  pokeId: 142, location: 'indigo' },
        { min: 22421, pokemon: 'Snorlax',     pokeId: 143, location: 'indigo' },
        // Indigo Plateau  Pokemon League
        { min: 22696, pokemon: 'Articuno',    pokeId: 144, location: 'indigo' },
        { min: 23219, pokemon: 'Zapdos',      pokeId: 145, location: 'indigo' },
        { min: 23460, pokemon: 'Moltres',     pokeId: 146, location: 'indigo' },
        { min: 23873, pokemon: 'Dratini',     pokeId: 147, location: 'indigo' },
        { min: 24285, pokemon: 'Dragonair',   pokeId: 148, location: 'indigo' },
        { min: 24643, pokemon: 'Dragonite',   pokeId: 149, location: 'indigo' },
        { min: 25000, pokemon: 'Mewtwo',      pokeId: 150, location: 'indigo' },
        { min: 30000, pokemon: 'Mew',         pokeId: 151, location: 'indigo' }
    ];

    function getPokemonLevel(pnl) {
        let level = POKEMON_LEVELS[0];
        for (const l of POKEMON_LEVELS) {
            if (pnl >= l.min) level = l;
        }
        return level;
    }

    function getNextPokemonLevel(currentLevel) {
        const idx = POKEMON_LEVELS.indexOf(currentLevel);
        if (idx >= 0 && idx < POKEMON_LEVELS.length - 1) return POKEMON_LEVELS[idx + 1];
        return null;
    }

    // Level-up detection
    const POKE_LEVEL_KEY = 'spx_pokemon_level';
    function getUnlockedPokeLevel() { return parseFloat(localStorage.getItem(POKE_LEVEL_KEY) || '0'); }
    function setUnlockedPokeLevel(val) { localStorage.setItem(POKE_LEVEL_KEY, String(val)); }

    function checkPokemonLevelUp(pnl) {
        const current = getPokemonLevel(pnl);
        const unlocked = getUnlockedPokeLevel();
        if (current.min > unlocked && unlocked >= 0) {
            showLevelUp(current);
            setUnlockedPokeLevel(current.min);
        }
    }

    function showLevelUp(level) {
        const overlay = document.getElementById('levelupOverlay');
        const sprite = document.getElementById('levelupSprite');
        const detail = document.getElementById('levelupDetail');
        const pokename = document.getElementById('levelupPokename');
        sprite.src = POKE_SPRITE(level.pokeId);
        sprite.className = 'levelup-pokemon evolving';
        detail.innerHTML = `Profit hit <span style="color:var(--green-bright);font-weight:700">$${level.min}</span><br>New base size: <span style="color:var(--pumpkin-glow);font-weight:700">$${level.base}</span>`;
        pokename.textContent = level.pokemon;
        overlay.style.display = 'flex';
        setTimeout(() => { sprite.className = 'levelup-pokemon'; }, 1500);
    }

    function dismissLevelUp() {
        const overlay = document.getElementById('levelupOverlay');
        overlay.style.transition = 'opacity 0.4s';
        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.style.display = 'none';
            overlay.style.opacity = '';
            overlay.style.transition = '';
        }, 400);
    }

    function renderPokemon(stats) {
        const box = document.getElementById('pokemonBox');
        if (!box) return;
        const pnlRaw = (stats.netPnl || '$0').replace('$', '').replace(',', '');
        const pnl = parseFloat(pnlRaw) || 0;
        const level = getPokemonLevel(pnl);
        const nextLevel = getNextPokemonLevel(level);
        const levelIdx = POKEMON_LEVELS.indexOf(level) + 1;

        const pnlStr = pnl >= 0 ? '+$' + pnl.toFixed(2) : '-$' + Math.abs(pnl).toFixed(2);
        const pnlClass = pnl > 0 ? 'positive' : pnl < 0 ? 'negative' : 'zero';

        // XP bar
        const xpFrom = level.min;
        const xpTo = nextLevel ? nextLevel.min : level.min;
        const xpRange = xpTo - xpFrom;
        const xpProgress = xpRange > 0 ? Math.max(0, Math.min(100, ((pnl - xpFrom) / xpRange) * 100)) : 100;

        const needStr = nextLevel ? '$' + nextLevel.min : '';

        let html = `<div class="pokemon-header">
            <div class="pokemon-level-name">Lv.${levelIdx}  ${level.pokemon}</div>
            <img class="pokemon-sprite" src="${POKE_SPRITE(level.pokeId)}" alt="${level.pokemon}">
            <div class="pokemon-pnl ${pnlClass}">P&L: ${pnlStr}${needStr ? ` <span style="color:var(--pumpkin-glow)">&middot; ${needStr} to evolve</span>` : ''}</div>
        </div>`;

        html += `<div class="pokemon-xp-bar">
            <div class="pokemon-xp-track">
                <div class="pokemon-xp-fill" style="width:${xpProgress}%"></div>
            </div>
            <div class="pokemon-xp-labels">
                <span>$${xpFrom}</span>
                <span>${xpProgress.toFixed(0)}%</span>
                <span>${nextLevel ? '$' + xpTo : 'MAX'}</span>
            </div>
        </div>`;

        if (nextLevel) {
            html += `<div class="pokemon-next-evolve">${level.pokemon} evolves at $${nextLevel.min} profit</div>`;
        } else {
            html += `<div class="pokemon-next-evolve">MAX LEVEL  You are the very best!</div>`;
        }

        // Set location background
        if (level.location && LOCATION_BG[level.location]) {
            box.style.setProperty('--location-bg', `url('${LOCATION_BG[level.location]}')`);
        }

        box.innerHTML = html;
        checkPokemonLevelUp(pnl);
    }

    // ====== INIT ======
    fetchData();
    fetchWeeklyTasks();

    // ====== SERVICE WORKER ======
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js');
    }
</script>

</body>
</html>
